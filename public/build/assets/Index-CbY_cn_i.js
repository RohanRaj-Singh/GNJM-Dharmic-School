import{r as n,j as t,z as F}from"./app-Dzq2inqo.js";import{A as G}from"./AdminLayout-znSisYpN.js";import"./logo-CAn8f4K1.js";function V(){const P=e=>{const s=String(e?.type??"").trim().toLowerCase();return s==="kirtan"||s==="kirtan class"?!0:String(e?.name??"").toLowerCase().includes("kirtan")},C=new Date,[i,k]=n.useState([]),[c,L]=n.useState(""),[E,b]=n.useState([]),[l,f]=n.useState(""),[h,R]=n.useState(C.getFullYear()),[p,W]=n.useState(String(C.getMonth()+1).padStart(2,"0")),[d,g]=n.useState(null),[u,z]=n.useState({}),[j,O]=n.useState({}),[w,y]=n.useState(!1),[_,K]=n.useState(0),A=n.useRef(null),M=n.useMemo(()=>i.find(e=>String(e.id)===String(c)),[i,c]),I=P(M);n.useEffect(()=>{fetch("/admin/classes/options").then(e=>e.json()).then(k).catch(()=>k([]))},[]),n.useEffect(()=>{i.length&&!c&&L(String(i[0].id))},[i]),n.useEffect(()=>{if(!c){b([]),f(""),g(null);return}fetch(`/admin/sections/options?class_id=${c}`).then(e=>e.json()).then(e=>{b(e),f(e.length?String(e[0].id):"")}).catch(()=>{b([]),f("")})},[c]),n.useEffect(()=>{if(!l){g(null);return}y(!0),fetch(`/admin/attendance/grid?section_id=${l}&year=${h}&month=${parseInt(p)}`).then(e=>e.json()).then(g).finally(()=>y(!1))},[l,h,p]);function T(e,s,a){if(!a)return;const r=`${e}-${s}`,m=Object.prototype.hasOwnProperty.call(u,r),v=d?.students?.find(x=>x.id===e)?.records?.[r]?.status??null,o=m?u[r]:v,N=o===null?"present":o==="present"?"absent":o==="absent"?"leave":null;z(x=>({...x,[r]:N}))}function Y(e,s,a){const r=`${e}-${s}`;O(m=>({...m,[r]:a}))}function q(){y(!0);const e=Object.entries(u).map(([s,a])=>{const r=String(s).match(/^(\d+)-(\d{4}-\d{2}-\d{2})$/);return r?{student_section_id:Number(r[1]),date:r[2],status:a,lesson_learned:I?j[s]??null:null}:null}).filter(Boolean);fetch("/admin/attendance/save",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({section_id:l,year:h,month:parseInt(p),records:e})}).then(s=>s.ok?s.json():s.json().catch(()=>({})).then(a=>{throw new Error(a?.message||"Failed to save attendance")})).then(()=>(F.success("Attendance saved"),z({}),O({}),fetch(`/admin/attendance/grid?section_id=${l}&year=${h}&month=${parseInt(p)}`).then(s=>s.json()))).then(g).catch(s=>F.error(s?.message||"Failed to save attendance")).finally(()=>y(!1))}const S=d?.days??[],D=d?.students??[];return n.useEffect(()=>{const e=()=>{K(A.current?.offsetWidth??0)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[d,c,l]),t.jsxs(G,{title:"Attendance",children:[t.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-center",children:[t.jsx("select",{value:c,onChange:e=>L(e.target.value),className:"border px-3 py-2 rounded text-sm",children:i.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("select",{value:l,onChange:e=>f(e.target.value),className:"border px-3 py-2 rounded text-sm",disabled:!E.length,children:E.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("input",{type:"month",value:`${h}-${p}`,onChange:e=>{const[s,a]=e.target.value.split("-");R(parseInt(s)),W(a)},className:"border px-3 py-2 rounded text-sm"}),d&&t.jsx("button",{onClick:q,disabled:w,className:"ml-auto px-4 py-2 bg-green-600 text-white rounded text-sm disabled:opacity-50",children:"Save Attendance"})]}),t.jsxs("div",{className:"relative bg-white border rounded overflow-x-auto",children:[(w||!d)&&t.jsx("div",{className:"absolute inset-0 bg-white/70 flex items-center justify-center z-30",children:t.jsx("p",{className:"text-sm text-gray-500",children:w?"Loading attendance...":"Attendance will appear here"})}),t.jsxs("table",{className:"min-w-max text-sm border-collapse",children:[t.jsx("thead",{className:"bg-gray-50 sticky top-0 z-20",children:t.jsxs("tr",{children:[t.jsx("th",{ref:A,className:"px-3 py-2 sticky left-0 bg-gray-50 z-30 text-left whitespace-nowrap",children:"Student"}),t.jsx("th",{className:"px-3 py-2 sticky bg-gray-50 z-30 text-left border-r whitespace-nowrap",style:{left:`${_}px`},children:"Father Name"}),S.map(e=>t.jsx("th",{className:`px-2 py-2 text-center ${e.enabled?"":"text-gray-300"}`,children:e.day},e.date))]})}),t.jsxs("tbody",{children:[D.map(e=>t.jsxs("tr",{className:"border-b",children:[t.jsx("td",{className:"px-3 py-2 sticky left-0 bg-white z-10 font-medium whitespace-nowrap",children:e.name}),t.jsx("td",{className:"px-3 py-2 sticky bg-white z-10 border-r text-gray-600 whitespace-nowrap",style:{left:`${_}px`},children:e.father_name||"-"}),S.map(s=>{const a=`${e.id}-${s.date}`,r=Object.prototype.hasOwnProperty.call(u,a),m=Object.prototype.hasOwnProperty.call(j,a),v=e.records?.[a]?.status??null,o=r?u[a]:v,N=e.records?.[a]?.lesson_learned??!1,x=m?j[a]:N,B=o==="present"?"bg-green-200 text-green-800":o==="absent"?"bg-red-200 text-red-800":o==="leave"?"bg-yellow-200 text-yellow-800":"";return t.jsxs("td",{onClick:()=>T(e.id,s.date,s.enabled),className:`px-2 py-2 text-center select-none
                        ${B}
                        ${s.enabled?"cursor-pointer hover:bg-gray-100":"bg-gray-100 text-gray-300 cursor-not-allowed"}`,children:[o?o[0].toUpperCase():"â€”",I&&o==="present"&&t.jsxs("div",{className:"mt-1 flex items-center justify-center gap-1",children:[t.jsx("input",{type:"checkbox",checked:x,onClick:$=>$.stopPropagation(),onChange:$=>Y(e.id,s.date,$.target.checked)}),t.jsx("span",{className:"text-xs",children:"Lesson"})]})]},s.date)})]},e.id)),!D.length&&t.jsx("tr",{children:t.jsx("td",{colSpan:S.length+2,className:"px-4 py-6 text-center text-gray-500",children:"No students found in this section"})})]})]})]})]})}export{V as default};
