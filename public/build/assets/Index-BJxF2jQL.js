import{r,j as t,z as l,a as k}from"./app-CU8RJ2JX.js";import{A as T}from"./AdminLayout-DtTgDvcV.js";import{u as M,f as j,g as A,a as D,b as O}from"./index-DNKFK4TQ.js";function y(){return document.querySelector('meta[name="csrf-token"]')?.content??""}function U(){const[d,m]=r.useState([]),[b,N]=r.useState([]),[f,x]=r.useState(""),[a,i]=r.useState({open:!1,classId:null,className:"",periods:[],editingId:null,amount:0,effective_from:"",effective_to:""}),p=r.useRef(null);function h(){fetch("/admin/classes/data").then(e=>e.json()).then(m)}r.useEffect(h,[]);function v(e,s,n){m(o=>o.map((c,E)=>E===e?{...c,[s]:n}:c))}function w({row:e,column:s,autoFocus:n=!1}){const o=n?p:null;return t.jsx("input",{ref:o,defaultValue:e.original[s.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:c=>v(e.index,s.id,c.target.value)})}async function u(e){if(!e.original.id){l.error("Save class first, then configure fee timeline");return}try{const s=await fetch(`/admin/classes/${e.original.id}/fee-periods`,{headers:{Accept:"application/json"}});if(!s.ok)throw new Error("Failed to load timeline");const n=await s.json();i({open:!0,classId:e.original.id,className:e.original.name,periods:n.periods??[],editingId:null,amount:0,effective_from:"",effective_to:""})}catch{l.error("Failed to load fee timeline")}}async function _(){if(!a.effective_from){l.error("Start month is required");return}const e=a.editingId?`/admin/classes/${a.classId}/fee-periods/${a.editingId}`:`/admin/classes/${a.classId}/fee-periods`,s=a.editingId?"PUT":"POST";try{const n=await fetch(e,{method:s,headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":y()},body:JSON.stringify({amount:Number(a.amount||0),effective_from:a.effective_from,effective_to:a.effective_to||null})});if(!n.ok){const o=await n.json().catch(()=>null),c=o?.message||Object.values(o?.errors??{}).flat()?.[0]||"Failed to save";throw new Error(c)}await u({original:{id:a.classId,name:a.className}}),l.success("Fee period saved")}catch(n){l.error(n.message||"Could not save period")}}async function C(e){if(confirm("Delete this fee period?"))try{const s=await fetch(`/admin/classes/${a.classId}/fee-periods/${e}`,{method:"DELETE",headers:{Accept:"application/json","X-CSRF-TOKEN":y()}});if(!s.ok){const n=await s.json().catch(()=>null),o=n?.message||Object.values(n?.errors??{}).flat()?.[0]||"Delete failed";throw new Error(o)}await u({original:{id:a.classId,name:a.className}}),l.success("Fee period deleted")}catch(s){l.error(s.message||"Could not delete period")}}function F(e){i(s=>({...s,editingId:e.id,amount:e.amount,effective_from:e.effective_from,effective_to:e.effective_to??""}))}const S=r.useMemo(()=>[{accessorKey:"name",header:"Class Name",cell:({row:e,column:s})=>t.jsx(w,{row:e,column:s,autoFocus:e.original.__isNew})},{accessorKey:"default_monthly_fee",header:"Legacy Monthly Fee",cell:({row:e})=>t.jsxs("span",{className:"text-gray-500",children:["Rs. ",e.original.default_monthly_fee??0]})},{accessorKey:"sections_count",header:"Sections",cell:({row:e})=>t.jsx("span",{className:"text-gray-600",children:e.original.sections_count??0})},{header:"Fee Timeline",cell:({row:e})=>t.jsx("button",{onClick:()=>u(e),className:"px-2 py-1 text-xs bg-slate-700 text-white rounded",children:"Manage"})}],[]),g=M({data:d,columns:S,getRowId:e=>e.id?`class-${e.id}`:e.__tempId,state:{sorting:b,globalFilter:f},onSortingChange:N,onGlobalFilterChange:x,getCoreRowModel:O(),getFilteredRowModel:D(),getSortedRowModel:A(),globalFilterFn:"includesString"});function I(){const e={id:null,__tempId:crypto.randomUUID(),name:"",default_monthly_fee:0,sections_count:0,__isNew:!0};m(s=>[e,...s]),requestAnimationFrame(()=>{p.current?.focus()})}function R(){if(d.some(e=>!e.name?.trim())){l.error("Class name cannot be empty");return}k.post("/admin/classes/save",{classes:d},{onSuccess:()=>{l.success("Classes saved"),h()},onError:()=>l.error("Save failed")})}return t.jsxs(T,{title:"Classes",children:[t.jsxs("div",{className:"flex flex-wrap justify-between gap-3 mb-4",children:[t.jsx("input",{className:"px-3 py-2 border rounded text-sm w-64",placeholder:"Search classes...",value:f,onChange:e=>x(e.target.value)}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:I,className:"px-4 py-2 bg-blue-600 text-white rounded",children:"+ Add Class"}),t.jsx("button",{onClick:R,className:"px-4 py-2 bg-green-600 text-white rounded",children:"Save Changes"})]})]}),t.jsx("div",{className:"bg-white border rounded overflow-auto",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50 border-b",children:g.getHeaderGroups().map(e=>t.jsx("tr",{children:e.headers.map(s=>t.jsxs("th",{className:"px-3 py-2 text-left font-medium cursor-pointer",onClick:s.column.getToggleSortingHandler(),children:[j(s.column.columnDef.header,s.getContext()),{asc:" ↑",desc:" ↓"}[s.column.getIsSorted()]??""]},s.id))},e.id))}),t.jsx("tbody",{children:g.getRowModel().rows.map(e=>t.jsx("tr",{className:"border-b hover:bg-gray-50",children:e.getVisibleCells().map(s=>t.jsx("td",{className:"px-3 py-2",children:j(s.column.columnDef.cell,s.getContext())},s.id))},e.id))})]})}),a.open&&t.jsx("div",{className:"fixed inset-0 z-40 bg-black/40 flex items-center justify-center p-4",children:t.jsxs("div",{className:"bg-white rounded shadow-xl w-full max-w-2xl p-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-3",children:[t.jsxs("h3",{className:"font-semibold",children:["Class Fee Timeline: ",a.className]}),t.jsx("button",{onClick:()=>i(e=>({...e,open:!1})),className:"text-sm text-gray-500",children:"Close"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-2 mb-3",children:[t.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 text-sm",placeholder:"Amount",value:a.amount,onChange:e=>i(s=>({...s,amount:Number(e.target.value||0)}))}),t.jsx("input",{type:"month",className:"border rounded px-2 py-1 text-sm",value:a.effective_from,onChange:e=>i(s=>({...s,effective_from:e.target.value}))}),t.jsx("input",{type:"month",className:"border rounded px-2 py-1 text-sm",value:a.effective_to,onChange:e=>i(s=>({...s,effective_to:e.target.value}))}),t.jsx("button",{onClick:_,className:"bg-blue-600 text-white rounded px-3 py-1 text-sm",children:a.editingId?"Update":"Add"})]}),t.jsx("div",{className:"border rounded max-h-80 overflow-auto",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"text-left px-3 py-2",children:"From"}),t.jsx("th",{className:"text-left px-3 py-2",children:"To"}),t.jsx("th",{className:"text-left px-3 py-2",children:"Amount"}),t.jsx("th",{className:"text-left px-3 py-2",children:"Action"})]})}),t.jsxs("tbody",{children:[a.periods.map(e=>t.jsxs("tr",{className:"border-t",children:[t.jsx("td",{className:"px-3 py-2",children:e.effective_from}),t.jsx("td",{className:"px-3 py-2",children:e.effective_to??"Open"}),t.jsxs("td",{className:"px-3 py-2",children:["Rs. ",e.amount]}),t.jsxs("td",{className:"px-3 py-2 space-x-2",children:[t.jsx("button",{onClick:()=>F(e),className:"text-blue-600 text-xs",children:"Edit"}),t.jsx("button",{onClick:()=>C(e.id),className:"text-red-600 text-xs",children:"Delete"})]})]},e.id)),a.periods.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"px-3 py-3 text-gray-500",children:"No fee periods configured."})})]})]})})]})})]})}export{U as default};
