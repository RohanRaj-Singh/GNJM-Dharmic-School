import{r as l,j as t,a as b,z as i}from"./app-CF_lZ-2m.js";import{A as T}from"./AdminLayout-z4FWjLSy.js";import{u as q,f as v,g as K,a as P,b as L}from"./index-Ci1oky2Z.js";function G(){const[d,m]=l.useState([]),[f,N]=l.useState([]),[_,w]=l.useState([]),[p,h]=l.useState(""),[n,c]=l.useState({open:!1,sectionId:null,sectionName:"",periods:[],editingId:null,amount:0,effective_from:"",effective_to:""}),g=l.useRef(null);l.useEffect(()=>{u(),fetch("/admin/classes/options").then(e=>e.json()).then(N)},[]);function u(){fetch("/admin/sections/data").then(e=>e.json()).then(m)}function j(e,s,a){m(o=>o.map((r,M)=>M===e?{...r,[s]:a}:r))}function C({row:e,column:s,autoFocus:a=!1}){const o=a?g:null;return t.jsx("input",{ref:o,defaultValue:e.original[s.id]??"",className:"min-w-36 px-2 py-1 border rounded text-sm",onBlur:r=>j(e.index,s.id,r.target.value.trim()),onKeyDown:r=>{r.key==="Enter"&&r.currentTarget.blur()}})}function S({row:e}){return t.jsxs("select",{value:e.original.class_id??"",className:"px-2 py-1 border rounded text-sm",onChange:s=>j(e.index,"class_id",s.target.value),children:[t.jsx("option",{value:"",children:"Select class"}),f.map(s=>t.jsx("option",{value:s.id,children:s.name},s.id))]})}async function x(e){if(!e.original.id){i.error("Save section first, then configure fee timeline");return}try{const a=(await window.axios.get(`/admin/sections/${e.original.id}/fee-periods`,{headers:{Accept:"application/json"}}))?.data??{};c({open:!0,sectionId:e.original.id,sectionName:e.original.name,periods:a.periods??[],editingId:null,amount:0,effective_from:"",effective_to:""})}catch{i.error("Failed to load fee timeline")}}async function I(){if(!n.effective_from){i.error("Start month is required");return}const e=n.editingId?`/admin/sections/${n.sectionId}/fee-periods/${n.editingId}`:`/admin/sections/${n.sectionId}/fee-periods`,s=n.editingId?"PUT":"POST";try{await window.axios.request({url:e,method:s.toLowerCase(),headers:{Accept:"application/json"},data:{amount:Number(n.amount||0),effective_from:n.effective_from,effective_to:n.effective_to||null}}),await x({original:{id:n.sectionId,name:n.sectionName}}),i.success("Fee period saved")}catch(a){const o=a?.response?.data,r=o?.message||Object.values(o?.errors??{}).flat()?.[0]||a?.message;i.error(r||"Could not save period")}}async function F(e){if(confirm("Delete this fee period?"))try{await window.axios.delete(`/admin/sections/${n.sectionId}/fee-periods/${e}`,{headers:{Accept:"application/json"}}),await x({original:{id:n.sectionId,name:n.sectionName}}),i.success("Fee period deleted")}catch(s){const a=s?.response?.data,o=a?.message||Object.values(a?.errors??{}).flat()?.[0]||s?.message;i.error(o||"Could not delete period")}}function R(e){c(s=>({...s,editingId:e.id,amount:e.amount,effective_from:e.effective_from,effective_to:e.effective_to??""}))}const k=l.useMemo(()=>[{accessorKey:"name",header:"Section Name",cell:({row:e,column:s})=>t.jsx(C,{row:e,column:s,autoFocus:e.original.__isNew})},{accessorKey:"class_id",header:"Class",cell:({row:e})=>t.jsx(S,{row:e})},{accessorKey:"monthly_fee",header:"Legacy Section Fee",cell:({row:e})=>t.jsxs("span",{className:"text-gray-500",children:["Rs. ",e.original.monthly_fee??0]})},{accessorKey:"student_sections_count",header:"Students",cell:({row:e})=>t.jsx("span",{className:"text-gray-600 text-sm",children:e.original.student_sections_count??0})},{header:"Fee Timeline",cell:({row:e})=>t.jsx("button",{onClick:()=>x(e),className:"px-2 py-1 text-xs bg-slate-700 text-white rounded",children:"Manage"})},{header:"Action",cell:({row:e})=>(e.original.student_sections_count??0)>0?t.jsx("span",{className:"text-gray-400 text-sm",children:"In use"}):t.jsx("button",{onClick:()=>D(e.original.id),className:"text-red-600 text-sm hover:underline",children:"Delete"})}],[f]),y=q({data:d,columns:k,getRowId:e=>e.id?`section-${e.id}`:e.__tempId,state:{sorting:_,globalFilter:p},onSortingChange:w,onGlobalFilterChange:h,getCoreRowModel:L(),getFilteredRowModel:P(),getSortedRowModel:K(),globalFilterFn:"includesString"});function $(){const e=[];d.forEach((a,o)=>{a.name?.trim()||e.push(`Row ${o+1}: Section name required`),a.class_id||e.push(`Row ${o+1}: Class required`)});const s=new Set;return d.forEach((a,o)=>{const r=`${a.class_id}-${a.name?.toLowerCase()}`;s.has(r)&&e.push(`Row ${o+1}: Duplicate section in same class`),s.add(r)}),e}function A(){const e=$();if(e.length){i.error(t.jsx("ul",{className:"list-disc ml-4",children:e.slice(0,5).map((s,a)=>t.jsx("li",{children:s},a))}),{duration:5e3});return}b.post("/admin/sections/save",{sections:d},{onSuccess:()=>{i.success("Sections saved"),u()},onError:()=>i.error("Save failed")})}function D(e){confirm("Delete this section? This cannot be undone.")&&b.delete(`/admin/sections/${e}`,{onSuccess:()=>{i.success("Section deleted"),u()},onError:s=>{i.error(s?.response?.data?.message||"Cannot delete section")}})}function E(){if(d.some(s=>s.__isNew&&!s.name)){i.error("Finish the current new section first");return}const e={id:null,__tempId:crypto.randomUUID(),name:"",class_id:"",monthly_fee:0,__isNew:!0};m(s=>[e,...s]),requestAnimationFrame(()=>{g.current?.focus()})}return t.jsxs(T,{title:"Sections",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-between mb-4",children:[t.jsx("input",{className:"px-3 py-2 border rounded text-sm w-full sm:w-64",placeholder:"Search sections...",value:p,onChange:e=>h(e.target.value)}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:E,className:"px-4 py-2 bg-blue-600 text-white rounded text-sm",children:"+ Add Section"}),t.jsx("button",{onClick:A,className:"px-4 py-2 bg-green-600 text-white rounded text-sm",children:"Save Changes"})]})]}),t.jsx("div",{className:"bg-white border rounded-lg overflow-auto max-h-[70vh]",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50 border-b sticky top-0",children:y.getHeaderGroups().map(e=>t.jsx("tr",{children:e.headers.map(s=>t.jsxs("th",{className:"px-3 py-2 text-left font-medium cursor-pointer",onClick:s.column.getToggleSortingHandler(),children:[v(s.column.columnDef.header,s.getContext()),s.column.getIsSorted()==="asc"&&" ↑",s.column.getIsSorted()==="desc"&&" ↓"]},s.id))},e.id))}),t.jsx("tbody",{children:y.getRowModel().rows.map(e=>t.jsx("tr",{className:"border-b hover:bg-gray-50",children:e.getVisibleCells().map(s=>t.jsx("td",{className:"px-3 py-2",children:v(s.column.columnDef.cell,s.getContext())},s.id))},e.id))})]})}),n.open&&t.jsx("div",{className:"fixed inset-0 z-40 bg-black/40 flex items-center justify-center p-4",children:t.jsxs("div",{className:"bg-white rounded shadow-xl w-full max-w-2xl p-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-3",children:[t.jsxs("h3",{className:"font-semibold",children:["Section Fee Timeline: ",n.sectionName]}),t.jsx("button",{onClick:()=>c(e=>({...e,open:!1})),className:"text-sm text-gray-500",children:"Close"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-2 mb-3",children:[t.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 text-sm",placeholder:"Amount",value:n.amount,onChange:e=>c(s=>({...s,amount:Number(e.target.value||0)}))}),t.jsx("input",{type:"month",className:"border rounded px-2 py-1 text-sm",value:n.effective_from,onChange:e=>c(s=>({...s,effective_from:e.target.value}))}),t.jsx("input",{type:"month",className:"border rounded px-2 py-1 text-sm",value:n.effective_to,onChange:e=>c(s=>({...s,effective_to:e.target.value}))}),t.jsx("button",{onClick:I,className:"bg-blue-600 text-white rounded px-3 py-1 text-sm",children:n.editingId?"Update":"Add"})]}),t.jsx("div",{className:"border rounded max-h-80 overflow-auto",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"text-left px-3 py-2",children:"From"}),t.jsx("th",{className:"text-left px-3 py-2",children:"To"}),t.jsx("th",{className:"text-left px-3 py-2",children:"Amount"}),t.jsx("th",{className:"text-left px-3 py-2",children:"Action"})]})}),t.jsxs("tbody",{children:[n.periods.map(e=>t.jsxs("tr",{className:"border-t",children:[t.jsx("td",{className:"px-3 py-2",children:e.effective_from}),t.jsx("td",{className:"px-3 py-2",children:e.effective_to??"Open"}),t.jsxs("td",{className:"px-3 py-2",children:["Rs. ",e.amount]}),t.jsxs("td",{className:"px-3 py-2 space-x-2",children:[t.jsx("button",{onClick:()=>R(e),className:"text-blue-600 text-xs",children:"Edit"}),t.jsx("button",{onClick:()=>F(e.id),className:"text-red-600 text-xs",children:"Delete"})]})]},e.id)),n.periods.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"px-3 py-3 text-gray-500",children:"No fee periods configured."})})]})]})})]})})]})}export{G as default};
