import{r as n,j as t,z as D}from"./app-CKCcpFSt.js";import{A as R}from"./AdminLayout-DVIreQcb.js";function J(){const C=new Date,[l,k]=n.useState([]),[o,O]=n.useState(""),[L,b]=n.useState([]),[i,g]=n.useState(""),[d,_]=n.useState(C.getFullYear()),[p,P]=n.useState(String(C.getMonth()+1).padStart(2,"0")),[h,f]=n.useState(null),[u,E]=n.useState({}),[j,A]=n.useState({}),[S,y]=n.useState(!1),I=n.useMemo(()=>l.find(e=>String(e.id)===String(o)),[l,o])?.type==="kirtan";n.useEffect(()=>{fetch("/admin/classes/options").then(e=>e.json()).then(k).catch(()=>k([]))},[]),n.useEffect(()=>{l.length&&!o&&O(String(l[0].id))},[l]),n.useEffect(()=>{if(!o){b([]),g(""),f(null);return}fetch(`/admin/sections/options?class_id=${o}`).then(e=>e.json()).then(e=>{b(e),g(e.length?String(e[0].id):"")}).catch(()=>{b([]),g("")})},[o]),n.useEffect(()=>{if(!i){f(null);return}y(!0),fetch(`/admin/attendance/grid?section_id=${i}&year=${d}&month=${parseInt(p)}`).then(e=>e.json()).then(f).finally(()=>y(!1))},[i,d,p]);function F(e,s,a){if(!a)return;const c=`${e}-${s}`,x=Object.prototype.hasOwnProperty.call(u,c),N=h?.students?.find(m=>m.id===e)?.records?.[c]?.status??null,r=x?u[c]:N,$=r===null?"present":r==="present"?"absent":r==="absent"?"leave":null;E(m=>({...m,[c]:$}))}function M(e,s,a){const c=`${e}-${s}`;A(x=>({...x,[c]:a}))}function T(){y(!0);const e=Object.fromEntries(Object.entries(u).map(([s,a])=>[s,{status:a,lesson_learned:I?j[s]??null:null}]));fetch("/admin/attendance/save",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({section_id:i,year:d,month:parseInt(p),records:e})}).then(s=>{if(!s.ok)throw new Error;return s.json()}).then(()=>(D.success("Attendance saved"),E({}),A({}),fetch(`/admin/attendance/grid?section_id=${i}&year=${d}&month=${parseInt(p)}`).then(s=>s.json()))).then(f).catch(()=>D.error("Failed to save attendance")).finally(()=>y(!1))}const v=h?.days??[],z=h?.students??[];return t.jsxs(R,{title:"Attendance",children:[t.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-center",children:[t.jsx("select",{value:o,onChange:e=>O(e.target.value),className:"border px-3 py-2 rounded text-sm",children:l.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("select",{value:i,onChange:e=>g(e.target.value),className:"border px-3 py-2 rounded text-sm",disabled:!L.length,children:L.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("input",{type:"month",value:`${d}-${p}`,onChange:e=>{const[s,a]=e.target.value.split("-");_(parseInt(s)),P(a)},className:"border px-3 py-2 rounded text-sm"}),h&&t.jsx("button",{onClick:T,disabled:S,className:"ml-auto px-4 py-2 bg-green-600 text-white rounded text-sm disabled:opacity-50",children:"Save Attendance"})]}),t.jsxs("div",{className:"relative bg-white border rounded overflow-x-auto",children:[(S||!h)&&t.jsx("div",{className:"absolute inset-0 bg-white/70 flex items-center justify-center z-30",children:t.jsx("p",{className:"text-sm text-gray-500",children:S?"Loading attendance...":"Attendance will appear here"})}),t.jsxs("table",{className:"min-w-max text-sm border-collapse",children:[t.jsx("thead",{className:"bg-gray-50 sticky top-0 z-20",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 sticky left-0 bg-gray-50 z-30 text-left",children:"Student"}),v.map(e=>t.jsx("th",{className:`px-2 py-2 text-center ${e.enabled?"":"text-gray-300"}`,children:e.day},e.date))]})}),t.jsxs("tbody",{children:[z.map(e=>t.jsxs("tr",{className:"border-b",children:[t.jsx("td",{className:"px-3 py-2 sticky left-0 bg-white z-10 font-medium",children:e.name}),v.map(s=>{const a=`${e.id}-${s.date}`,c=Object.prototype.hasOwnProperty.call(u,a),x=Object.prototype.hasOwnProperty.call(j,a),N=e.records?.[a]?.status??null,r=c?u[a]:N,$=e.records?.[a]?.lesson_learned??!1,m=x?j[a]:$,K=r==="present"?"bg-green-200 text-green-800":r==="absent"?"bg-red-200 text-red-800":r==="leave"?"bg-yellow-200 text-yellow-800":"";return t.jsxs("td",{onClick:()=>F(e.id,s.date,s.enabled),className:`px-2 py-2 text-center select-none
                        ${K}
                        ${s.enabled?"cursor-pointer hover:bg-gray-100":"bg-gray-100 text-gray-300 cursor-not-allowed"}`,children:[r?r[0].toUpperCase():"â€”",I&&r==="present"&&t.jsxs("div",{className:"mt-1 flex items-center justify-center gap-1",children:[t.jsx("input",{type:"checkbox",checked:m,onClick:w=>w.stopPropagation(),onChange:w=>M(e.id,s.date,w.target.checked)}),t.jsx("span",{className:"text-xs",children:"Lesson"})]})]},s.date)})]},e.id)),!z.length&&t.jsx("tr",{children:t.jsx("td",{colSpan:v.length+1,className:"px-4 py-6 text-center text-gray-500",children:"No students found in this section"})})]})]})]})]})}export{J as default};
