import{j as s,r as l,z as o,a as M}from"./app-BEcnfxoP.js";import{A as Y}from"./AdminLayout-ev5PLz0o.js";import Z from"./EnrollmentsCell-DFMejSuG.js";import ee from"./useStudentFilters-DMthhwUz.js";import{u as te,f as E,g as se,a as ne,b as re}from"./index-zSei2GBz.js";function le({text:d="Loading..."}){return s.jsx("div",{className:"relative min-h-[300px] bg-white border rounded-lg",children:s.jsx("div",{className:"absolute inset-0 z-30 bg-white/80 flex items-center justify-center",children:s.jsxs("div",{className:"flex flex-col items-center gap-3",children:[s.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-gray-300 border-t-blue-600"}),s.jsx("p",{className:"text-sm text-gray-600",children:d})]})})})}function ue(){const[d,c]=l.useState([]),[x,$]=l.useState([]),[u,P]=l.useState({}),[T,I]=l.useState([]),[_,N]=l.useState(""),[p,C]=l.useState(!0),[F,w]=l.useState(!1),[R,m]=l.useState(!1),[g,k]=l.useState(!1),b=l.useRef(!1),j=l.useRef(null),{classFilter:i,sectionFilter:f,feeFilter:h,setClassFilter:U,setSectionFilter:B,setFeeFilter:L,columnFilters:z,filterFns:K,resetFilters:V}=ee();l.useEffect(()=>{S()},[]);function S(){return C(!0),w(!1),Promise.all([fetch("/admin/students/data").then(e=>e.json()),fetch("/admin/classes/options").then(e=>e.json())]).then(([e,t])=>{const n=e.map(r=>({...r,enrollments:(r.enrollments||[]).map(a=>({id:a.id??crypto.randomUUID(),class_id:String(a.class_id??""),section_id:String(a.section_id??""),student_type:a.student_type??"paid"}))}));return c(n),$(t),n}).catch(()=>o.error("Failed to load students")).finally(()=>C(!1))}l.useEffect(()=>{if(!p){const e=setTimeout(()=>w(!0),300);return()=>clearTimeout(e)}},[p]);function y(e,t,n){c(r=>r.map((a,X)=>X===e?{...a,[t]:n}:a)),m(!0)}function q(e){if(!e)return;const t=String(e);u[t]||fetch(`/admin/sections/options?class_id=${e}`).then(n=>n.json()).then(n=>P(r=>({...r,[t]:n})))}const G=l.useMemo(()=>{if(i==="all")return[];const e=u[String(i)];return Array.isArray(e)?e.map(t=>({id:String(t.id),name:t.name})):[]},[i,u]);function D({row:e,column:t}){return s.jsx("input",{defaultValue:e.original[t.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:n=>{const r=n.target.value.trim();if(r&&!/^\d{10,15}$/.test(r)){o.error("Phone must be 10–15 digits");return}y(e.index,t.id,r)}})}const H=l.useMemo(()=>[{header:"#",cell:({row:e})=>e.index+1},{accessorKey:"name",header:"Name",enableSorting:!0,cell:({row:e,column:t})=>s.jsx(v,{row:e,column:t,autoFocus:e.original.__isNew})},{accessorKey:"father_name",header:"Father",cell:({row:e,column:t})=>s.jsx(v,{row:e,column:t})},{accessorKey:"father_phone",header:"Father Phone",cell:({row:e,column:t})=>s.jsx(D,{row:e,column:t})},{accessorKey:"mother_phone",header:"Mother Phone",cell:({row:e,column:t})=>s.jsx(D,{row:e,column:t})},{header:"Enrollments",cell:({row:e})=>s.jsx(Z,{row:e,classes:x,sectionsByClass:u,loadSections:q,setData:c,setIsDirty:m})},{header:"Actions",cell:({row:e})=>s.jsx("button",{className:"text-red-600 text-sm",onClick:()=>{if(confirm("Delete this student? All enrollments will be removed.")){const t=e.original.id;if(!t){c(n=>n.filter((r,a)=>a!==e.index)),m(!0);return}M.delete(`/admin/students/${t}`,{preserveScroll:!0,onSuccess:()=>{S().then(n=>{if(n?.some(a=>String(a.id)===String(t))){o.error("Delete failed. Student still exists.");return}o.success("Student deleted")})},onError:()=>o.error("Failed to delete student")})}},children:"Delete"})}],[x,u]),O=l.useMemo(()=>d.filter(e=>!(i!=="all"&&!e.enrollments?.some(n=>String(n.class_id)===String(i))||f!=="all"&&!e.enrollments?.some(n=>String(n.section_id)===String(f))||h!=="all"&&!e.enrollments?.some(n=>h==="free"?n.student_type==="free":n.student_type!=="free"))),[d,i,f,h]),A=te({data:O,columns:H,getRowId:e=>e.id?`student-${e.id}`:e.__tempId,state:{sorting:T,globalFilter:_,columnFilters:z},filterFns:K,onSortingChange:I,onGlobalFilterChange:N,getCoreRowModel:re(),getFilteredRowModel:ne(),getSortedRowModel:se(),globalFilterFn:"includesString"});function J(){if(!F)return;if(d.some(t=>t.__isNew&&!t.name?.trim())){o.error("Finish the current new student first");return}c(t=>[{id:null,__tempId:crypto.randomUUID(),name:"",father_name:"",father_phone:"",mother_phone:"",status:"active",enrollments:[],__isNew:!0},...t]),m(!0),requestAnimationFrame(()=>{j.current?.focus()})}function Q(e){if(!e.name?.trim())return"Student name is required";if(!e.enrollments?.length)return"At least one enrollment required";const t=new Set;for(const n of e.enrollments){if(!n.class_id||!n.section_id)return"Each enrollment needs class & section";const r=`${n.class_id}-${n.section_id}`;if(t.has(r))return"Duplicate class + section enrollment";t.add(r)}return null}function W(){if(!R||b.current)return;const e=[],t=[];if(d.forEach((n,r)=>{const a=Q(n);a?e.push(`Row ${r+1}: ${a}`):t.push(n)}),e.length){o.error(s.jsxs("div",{children:[s.jsx("strong",{children:"Fix these issues:"}),s.jsx("ul",{className:"list-disc ml-4 mt-1",children:e.slice(0,5).map((n,r)=>s.jsx("li",{children:n},r))})]}),{duration:6e3});return}k(!0),b.current=!0,M.post("/admin/students/bulk-update",{students:t},{preserveScroll:!0,onSuccess:()=>{o.success("Changes saved"),m(!1),S()},onFinish:()=>{k(!1),b.current=!1}})}function v({row:e,column:t,autoFocus:n=!1}){return s.jsx("input",{ref:n?j:null,defaultValue:e.original[t.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:r=>y(e.index,t.id,r.target.value)})}return s.jsxs(Y,{title:"Students",children:[s.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-center justify-between",children:[s.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[s.jsx("input",{className:"px-3 py-2 border rounded text-sm w-64",placeholder:"Search…",value:_,onChange:e=>N(e.target.value)}),s.jsxs("select",{value:i,onChange:e=>U(e.target.value),className:"px-3 py-2 border rounded text-sm",children:[s.jsx("option",{value:"all",children:"All Classes"}),x.map(e=>s.jsx("option",{value:String(e.id),children:e.name},e.id))]}),s.jsxs("select",{value:f,onChange:e=>B(e.target.value),disabled:i==="all",className:"px-3 py-2 border rounded text-sm disabled:bg-gray-100",children:[s.jsx("option",{value:"all",children:i==="all"?"Select class first":"All Sections"}),G.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),s.jsxs("select",{value:h,onChange:e=>L(e.target.value),className:"px-3 py-2 border rounded text-sm",children:[s.jsx("option",{value:"all",children:"Paid & Free"}),s.jsx("option",{value:"paid",children:"Paid"}),s.jsx("option",{value:"free",children:"Free"})]}),s.jsx("button",{onClick:V,className:"px-3 py-2 border rounded text-sm",children:"Reset"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:J,disabled:!F,className:"px-4 py-2 bg-blue-600 text-white rounded text-sm disabled:opacity-50",children:"+ Add Student"}),s.jsx("button",{onClick:W,disabled:!R||g,className:`px-4 py-2 rounded text-sm text-white ${g?"bg-green-400":"bg-green-600 hover:bg-green-700"} disabled:opacity-50`,children:g?"Saving…":"Save Changes"})]})]}),p?s.jsx(le,{text:"Loading students…"}):s.jsx("div",{className:"bg-white border rounded overflow-x-auto",children:s.jsxs("table",{className:"min-w-[900px] text-sm",children:[s.jsx("thead",{className:"bg-gray-50",children:A.getHeaderGroups().map(e=>s.jsx("tr",{children:e.headers.map(t=>s.jsxs("th",{className:"px-3 py-2 cursor-pointer select-none",onClick:t.column.getToggleSortingHandler(),children:[E(t.column.columnDef.header,t.getContext()),{asc:" ▲",desc:" ▼"}[t.column.getIsSorted()]??""]},t.id))},e.id))}),s.jsx("tbody",{children:A.getRowModel().rows.map(e=>s.jsx("tr",{className:"border-b",children:e.getVisibleCells().map(t=>s.jsx("td",{className:`px-3 py-2 min-${t.column.columnDef.header==="#"?"w-auto":"w-[150px]"} border-b align-top`,children:E(t.column.columnDef.cell,t.getContext())},t.id))},e.id))})]})})]})}export{ue as default};
