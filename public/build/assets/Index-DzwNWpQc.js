import{r as n,j as t,z}from"./app--Y77DcYM.js";import{A as T}from"./AdminLayout-DQxr6T18.js";function R(){const v=new Date,[i,N]=n.useState([]),[c,$]=n.useState(""),[C,f]=n.useState([]),[d,p]=n.useState(""),[u,_]=n.useState(v.getFullYear()),[h,O]=n.useState(String(v.getMonth()+1).padStart(2,"0")),[m,x]=n.useState(null),[y,w]=n.useState({}),[k,E]=n.useState({}),[b,g]=n.useState(!1),L=n.useMemo(()=>i.find(e=>String(e.id)===String(c)),[i,c]);console.log("Selected class:",L);const A=L?.name?.toLowerCase().includes("kirtan");n.useEffect(()=>{fetch("/admin/classes/options").then(e=>e.json()).then(N).catch(()=>N([]))},[]),n.useEffect(()=>{i.length&&!c&&$(String(i[0].id))},[i]),n.useEffect(()=>{if(!c){f([]),p(""),x(null);return}fetch(`/admin/sections/options?class_id=${c}`).then(e=>e.json()).then(e=>{f(e),p(e.length?String(e[0].id):"")}).catch(()=>{f([]),p("")})},[c]),n.useEffect(()=>{if(!d){x(null);return}g(!0),fetch(`/admin/attendance/grid?section_id=${d}&year=${u}&month=${parseInt(h)}`).then(e=>e.json()).then(x).finally(()=>g(!1))},[d,u,h]);function D(e,s,a){if(!a)return;const r=`${e}-${s}`,l=y[r]??m?.students?.find(o=>o.id===e)?.records?.[r]?.status??null,S=l===null?"present":l==="present"?"absent":l==="absent"?"leave":null;w(o=>({...o,[r]:S}))}function F(e,s,a){const r=`${e}-${s}`;E(l=>({...l,[r]:a}))}function M(){g(!0);const e=Object.fromEntries(Object.entries(y).map(([s,a])=>[s,{status:a,lesson_learned:A?k[s]??null:null}]));fetch("/admin/attendance/save",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({section_id:d,year:u,month:parseInt(h),records:e})}).then(s=>{if(!s.ok)throw new Error;return s.json()}).then(()=>(z.success("Attendance saved"),w({}),E({}),fetch(`/admin/attendance/grid?section_id=${d}&year=${u}&month=${parseInt(h)}`).then(s=>s.json()))).then(x).catch(()=>z.error("Failed to save attendance")).finally(()=>g(!1))}const j=m?.days??[],I=m?.students??[];return t.jsxs(T,{title:"Attendance",children:[t.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-center",children:[t.jsx("select",{value:c,onChange:e=>$(e.target.value),className:"border px-3 py-2 rounded text-sm",children:i.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("select",{value:d,onChange:e=>p(e.target.value),className:"border px-3 py-2 rounded text-sm",disabled:!C.length,children:C.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("input",{type:"month",value:`${u}-${h}`,onChange:e=>{const[s,a]=e.target.value.split("-");_(parseInt(s)),O(a)},className:"border px-3 py-2 rounded text-sm"}),m&&t.jsx("button",{onClick:M,disabled:b,className:"ml-auto px-4 py-2 bg-green-600 text-white rounded text-sm disabled:opacity-50",children:"Save Attendance"})]}),t.jsxs("div",{className:"relative bg-white border rounded overflow-x-auto",children:[(b||!m)&&t.jsx("div",{className:"absolute inset-0 bg-white/70 flex items-center justify-center z-30",children:t.jsx("p",{className:"text-sm text-gray-500",children:b?"Loading attendance...":"Attendance will appear here"})}),t.jsxs("table",{className:"min-w-max text-sm border-collapse",children:[t.jsx("thead",{className:"bg-gray-50 sticky top-0 z-20",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 sticky left-0 bg-gray-50 z-30 text-left",children:"Student"}),j.map(e=>t.jsx("th",{className:`px-2 py-2 text-center ${e.enabled?"":"text-gray-300"}`,children:e.day},e.date))]})}),t.jsxs("tbody",{children:[I.map(e=>t.jsxs("tr",{className:"border-b",children:[t.jsx("td",{className:"px-3 py-2 sticky left-0 bg-white z-10 font-medium",children:e.name}),j.map(s=>{const a=`${e.id}-${s.date}`,r=y[a]??e.records?.[a]?.status??null,l=k[a]??e.records?.[a]?.lesson_learned??!1,S=r==="present"?"bg-green-200 text-green-800":r==="absent"?"bg-red-200 text-red-800":r==="leave"?"bg-yellow-200 text-yellow-800":"";return t.jsxs("td",{onClick:()=>D(e.id,s.date,s.enabled),className:`px-2 py-2 text-center select-none
                        ${S}
                        ${s.enabled?"cursor-pointer hover:bg-gray-100":"bg-gray-100 text-gray-300 cursor-not-allowed"}`,children:[r?r[0].toUpperCase():"â€”",A&&r==="present"&&t.jsxs("div",{className:"mt-1 flex items-center justify-center gap-1",children:[t.jsx("input",{type:"checkbox",checked:l,onClick:o=>o.stopPropagation(),onChange:o=>F(e.id,s.date,o.target.checked)}),t.jsx("span",{className:"text-xs",children:"Lesson"})]})]},s.date)})]},e.id)),!I.length&&t.jsx("tr",{children:t.jsx("td",{colSpan:j.length+1,className:"px-4 py-6 text-center text-gray-500",children:"No students found in this section"})})]})]})]})]})}export{R as default};
