import{r as l,j as s,a as p,z as r}from"./app-CCcfqxc9.js";import{A as I}from"./AdminLayout-Bja5RjfC.js";import{u as M,f as b,g as $,a as k,b as A}from"./index-DYXgx6bw.js";function G(){const[i,c]=l.useState([]),[m,j]=l.useState([]),[y,S]=l.useState([]),[x,h]=l.useState(""),f=l.useRef(null);l.useEffect(()=>{d(),fetch("/admin/classes/options").then(e=>e.json()).then(j)},[]);function d(){fetch("/admin/sections/data").then(e=>e.json()).then(c)}function u(e,t,n){c(a=>a.map((o,E)=>E===e?{...o,[t]:n}:o))}function w({row:e,column:t,autoFocus:n=!1}){const a=n?f:null;return s.jsx("input",{ref:a,defaultValue:e.original[t.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:o=>u(e.index,t.id,o.target.value.trim()),onKeyDown:o=>{o.key==="Enter"&&o.currentTarget.blur()}})}function C({row:e,column:t}){return s.jsx("input",{type:"number",min:"0",className:"w-full px-2 py-1 border rounded text-sm",defaultValue:e.original[t.id]??0,onBlur:n=>u(e.index,t.id,Number(n.target.value)||0)})}function _({row:e}){return s.jsxs("select",{value:e.original.class_id??"",className:"w-full px-2 py-1 border rounded text-sm",onChange:t=>u(e.index,"class_id",t.target.value),children:[s.jsx("option",{value:"",children:"Select class"}),m.map(t=>s.jsx("option",{value:t.id,children:t.name},t.id))]})}const N=l.useMemo(()=>[{accessorKey:"name",header:"Section Name",cell:({row:e,column:t})=>s.jsx(w,{row:e,column:t,autoFocus:e.original.__isNew})},{accessorKey:"class_id",header:"Class",cell:({row:e})=>s.jsx(_,{row:e})},{accessorKey:"monthly_fee",header:"Section Fee",cell:({row:e,column:t})=>s.jsx(C,{row:e,column:t})},{accessorKey:"student_sections_count",header:"Students",cell:({row:e})=>s.jsx("span",{className:"text-gray-600 text-sm",children:e.original.student_sections_count??0})},{header:"Action",cell:({row:e})=>(e.original.student_sections_count??0)>0?s.jsx("span",{className:"text-gray-400 text-sm",children:"In use"}):s.jsx("button",{onClick:()=>F(e.original.id),className:"text-red-600 text-sm hover:underline",children:"Delete"})}],[m]),g=M({data:i,columns:N,getRowId:e=>e.id?`section-${e.id}`:e.__tempId,state:{sorting:y,globalFilter:x},onSortingChange:S,onGlobalFilterChange:h,getCoreRowModel:A(),getFilteredRowModel:k(),getSortedRowModel:$(),globalFilterFn:"includesString"});function v(){const e=[];i.forEach((n,a)=>{n.name?.trim()||e.push(`Row ${a+1}: Section name required`),n.class_id||e.push(`Row ${a+1}: Class required`),n.monthly_fee<0&&e.push(`Row ${a+1}: Fee cannot be negative`)});const t=new Set;return i.forEach((n,a)=>{const o=`${n.class_id}-${n.name?.toLowerCase()}`;t.has(o)&&e.push(`Row ${a+1}: Duplicate section in same class`),t.add(o)}),e}function R(){const e=v();if(e.length){r.error(s.jsx("ul",{className:"list-disc ml-4",children:e.slice(0,5).map((t,n)=>s.jsx("li",{children:t},n))}),{duration:5e3});return}p.post("/admin/sections/save",{sections:i},{onSuccess:()=>{r.success("Sections saved"),d()},onError:()=>r.error("Save failed")})}function F(e){confirm("Delete this section? This cannot be undone.")&&p.delete(`/admin/sections/${e}`,{onSuccess:()=>{r.success("Section deleted"),d()},onError:t=>{r.error(t?.response?.data?.message||"Cannot delete section")}})}function D(){if(i.some(t=>t.__isNew&&!t.name)){r.error("Finish the current new section first");return}const e={id:null,__tempId:crypto.randomUUID(),name:"",class_id:"",monthly_fee:0,__isNew:!0};c(t=>[e,...t]),requestAnimationFrame(()=>{f.current?.focus()})}return s.jsxs(I,{title:"Sections",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-between mb-4",children:[s.jsx("input",{className:"px-3 py-2 border rounded text-sm w-full sm:w-64",placeholder:"Search sections…",value:x,onChange:e=>h(e.target.value)}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:D,className:"px-4 py-2 bg-blue-600 text-white rounded text-sm",children:"+ Add Section"}),s.jsx("button",{onClick:R,className:"px-4 py-2 bg-green-600 text-white rounded text-sm",children:"Save Changes"})]})]}),s.jsx("div",{className:"bg-white border rounded-lg overflow-auto max-h-[70vh]",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"bg-gray-50 border-b sticky top-0",children:g.getHeaderGroups().map(e=>s.jsx("tr",{children:e.headers.map(t=>s.jsxs("th",{className:"px-3 py-2 text-left font-medium cursor-pointer",onClick:t.column.getToggleSortingHandler(),children:[b(t.column.columnDef.header,t.getContext()),t.column.getIsSorted()==="asc"&&" ↑",t.column.getIsSorted()==="desc"&&" ↓"]},t.id))},e.id))}),s.jsx("tbody",{children:g.getRowModel().rows.map(e=>s.jsx("tr",{className:"border-b hover:bg-gray-50",children:e.getVisibleCells().map(t=>s.jsx("td",{className:"px-3 py-2",children:b(t.column.columnDef.cell,t.getContext())},t.id))},e.id))})]})})]})}export{G as default};
