import{r as n,j as t,z as P}from"./app-D_XvPUgR.js";import{A as q}from"./AdminLayout-CUfU-eBC.js";import"./logo-CAn8f4K1.js";function V(){const C=new Date,[i,k]=n.useState([]),[o,E]=n.useState(""),[L,b]=n.useState([]),[l,f]=n.useState(""),[p,F]=n.useState(C.getFullYear()),[h,R]=n.useState(String(C.getMonth()+1).padStart(2,"0")),[d,g]=n.useState(null),[u,O]=n.useState({}),[j,z]=n.useState({}),[w,y]=n.useState(!1),[A,W]=n.useState(0),I=n.useRef(null),_=n.useMemo(()=>i.find(e=>String(e.id)===String(o)),[i,o])?.type==="kirtan";n.useEffect(()=>{fetch("/admin/classes/options").then(e=>e.json()).then(k).catch(()=>k([]))},[]),n.useEffect(()=>{i.length&&!o&&E(String(i[0].id))},[i]),n.useEffect(()=>{if(!o){b([]),f(""),g(null);return}fetch(`/admin/sections/options?class_id=${o}`).then(e=>e.json()).then(e=>{b(e),f(e.length?String(e[0].id):"")}).catch(()=>{b([]),f("")})},[o]),n.useEffect(()=>{if(!l){g(null);return}y(!0),fetch(`/admin/attendance/grid?section_id=${l}&year=${p}&month=${parseInt(h)}`).then(e=>e.json()).then(g).finally(()=>y(!1))},[l,p,h]);function M(e,s,a){if(!a)return;const c=`${e}-${s}`,x=Object.prototype.hasOwnProperty.call(u,c),v=d?.students?.find(m=>m.id===e)?.records?.[c]?.status??null,r=x?u[c]:v,N=r===null?"present":r==="present"?"absent":r==="absent"?"leave":null;O(m=>({...m,[c]:N}))}function T(e,s,a){const c=`${e}-${s}`;z(x=>({...x,[c]:a}))}function K(){y(!0);const e=Object.fromEntries(Object.entries(u).map(([s,a])=>[s,{status:a,lesson_learned:_?j[s]??null:null}]));fetch("/admin/attendance/save",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({section_id:l,year:p,month:parseInt(h),records:e})}).then(s=>{if(!s.ok)throw new Error;return s.json()}).then(()=>(P.success("Attendance saved"),O({}),z({}),fetch(`/admin/attendance/grid?section_id=${l}&year=${p}&month=${parseInt(h)}`).then(s=>s.json()))).then(g).catch(()=>P.error("Failed to save attendance")).finally(()=>y(!1))}const S=d?.days??[],D=d?.students??[];return n.useEffect(()=>{const e=()=>{W(I.current?.offsetWidth??0)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[d,o,l]),t.jsxs(q,{title:"Attendance",children:[t.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-center",children:[t.jsx("select",{value:o,onChange:e=>E(e.target.value),className:"border px-3 py-2 rounded text-sm",children:i.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("select",{value:l,onChange:e=>f(e.target.value),className:"border px-3 py-2 rounded text-sm",disabled:!L.length,children:L.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("input",{type:"month",value:`${p}-${h}`,onChange:e=>{const[s,a]=e.target.value.split("-");F(parseInt(s)),R(a)},className:"border px-3 py-2 rounded text-sm"}),d&&t.jsx("button",{onClick:K,disabled:w,className:"ml-auto px-4 py-2 bg-green-600 text-white rounded text-sm disabled:opacity-50",children:"Save Attendance"})]}),t.jsxs("div",{className:"relative bg-white border rounded overflow-x-auto",children:[(w||!d)&&t.jsx("div",{className:"absolute inset-0 bg-white/70 flex items-center justify-center z-30",children:t.jsx("p",{className:"text-sm text-gray-500",children:w?"Loading attendance...":"Attendance will appear here"})}),t.jsxs("table",{className:"min-w-max text-sm border-collapse",children:[t.jsx("thead",{className:"bg-gray-50 sticky top-0 z-20",children:t.jsxs("tr",{children:[t.jsx("th",{ref:I,className:"px-3 py-2 sticky left-0 bg-gray-50 z-30 text-left whitespace-nowrap",children:"Student"}),t.jsx("th",{className:"px-3 py-2 sticky bg-gray-50 z-30 text-left border-r whitespace-nowrap",style:{left:`${A}px`},children:"Father Name"}),S.map(e=>t.jsx("th",{className:`px-2 py-2 text-center ${e.enabled?"":"text-gray-300"}`,children:e.day},e.date))]})}),t.jsxs("tbody",{children:[D.map(e=>t.jsxs("tr",{className:"border-b",children:[t.jsx("td",{className:"px-3 py-2 sticky left-0 bg-white z-10 font-medium whitespace-nowrap",children:e.name}),t.jsx("td",{className:"px-3 py-2 sticky bg-white z-10 border-r text-gray-600 whitespace-nowrap",style:{left:`${A}px`},children:e.father_name||"-"}),S.map(s=>{const a=`${e.id}-${s.date}`,c=Object.prototype.hasOwnProperty.call(u,a),x=Object.prototype.hasOwnProperty.call(j,a),v=e.records?.[a]?.status??null,r=c?u[a]:v,N=e.records?.[a]?.lesson_learned??!1,m=x?j[a]:N,Y=r==="present"?"bg-green-200 text-green-800":r==="absent"?"bg-red-200 text-red-800":r==="leave"?"bg-yellow-200 text-yellow-800":"";return t.jsxs("td",{onClick:()=>M(e.id,s.date,s.enabled),className:`px-2 py-2 text-center select-none
                        ${Y}
                        ${s.enabled?"cursor-pointer hover:bg-gray-100":"bg-gray-100 text-gray-300 cursor-not-allowed"}`,children:[r?r[0].toUpperCase():"â€”",_&&r==="present"&&t.jsxs("div",{className:"mt-1 flex items-center justify-center gap-1",children:[t.jsx("input",{type:"checkbox",checked:m,onClick:$=>$.stopPropagation(),onChange:$=>T(e.id,s.date,$.target.checked)}),t.jsx("span",{className:"text-xs",children:"Lesson"})]})]},s.date)})]},e.id)),!D.length&&t.jsx("tr",{children:t.jsx("td",{colSpan:S.length+2,className:"px-4 py-6 text-center text-gray-500",children:"No students found in this section"})})]})]})]})]})}export{V as default};
