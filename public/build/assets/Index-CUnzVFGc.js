import{j as n,r as l,z as d,a as A}from"./app-C_YOFr3M.js";import{A as le}from"./AdminLayout-Cja4yVUZ.js";import ie from"./EnrollmentsCell-CLHEV_kR.js";import ae from"./useStudentFilters-DRm3QYyj.js";import{u as oe,f as P,g as de,a as ce,b as ue}from"./index-Cpk4Id2Y.js";import"./logo-CAn8f4K1.js";function me({text:o="Loading..."}){return n.jsx("div",{className:"relative min-h-[300px] bg-white border rounded-lg",children:n.jsx("div",{className:"absolute inset-0 z-30 bg-white/80 flex items-center justify-center",children:n.jsxs("div",{className:"flex flex-col items-center gap-3",children:[n.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-gray-300 border-t-blue-600"}),n.jsx("p",{className:"text-sm text-gray-600",children:o})]})})})}function ye(){const[o,c]=l.useState([]),[_,U]=l.useState([]),[m,B]=l.useState({}),[L,K]=l.useState([]),[w,C]=l.useState(""),[g,N]=l.useState(!0),[F,R]=l.useState(!1),[D,u]=l.useState(!1),[x,I]=l.useState(!1),[b,k]=l.useState(null),[$,W]=l.useState(0),y=l.useRef(!1),E=l.useRef(null),M=l.useRef(null),T=()=>globalThis.crypto?.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,{classFilter:a,sectionFilter:f,feeFilter:p,setClassFilter:G,setSectionFilter:H,setFeeFilter:V,columnFilters:q,filterFns:O,resetFilters:J}=ae();l.useEffect(()=>{S()},[]);function S(){return N(!0),R(!1),Promise.all([fetch("/admin/students/data").then(e=>e.json()),fetch("/admin/classes/options").then(e=>e.json())]).then(([e,t])=>{const s=e.map(i=>({...i,enrollments:(i.enrollments||[]).map(r=>({id:r.id??T(),class_id:String(r.class_id??""),section_id:String(r.section_id??""),student_type:r.student_type??"paid"}))}));return c(s),U(t),s}).catch(()=>d.error("Failed to load students")).finally(()=>N(!1))}l.useEffect(()=>{if(!g){const e=setTimeout(()=>R(!0),300);return()=>clearTimeout(e)}},[g]),l.useEffect(()=>{if(!b)return;const e=setTimeout(()=>{E.current?.focus(),k(null)},0);return()=>clearTimeout(e)},[b,o.length]),l.useEffect(()=>{const e=()=>{W(M.current?.offsetWidth??0)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[o.length]);const h=l.useCallback((e,t,s)=>{c(i=>i.map(r=>(r.id??r.__tempId)===e?{...r,[t]:s}:r)),u(!0)},[]);function Q(e){if(!e)return;const t=String(e);m[t]||fetch(`/admin/sections/options?class_id=${e}`).then(s=>s.json()).then(s=>B(i=>({...i,[t]:s})))}const X=l.useMemo(()=>{if(a==="all")return[];const e=m[String(a)];return Array.isArray(e)?e.map(t=>({id:String(t.id),name:t.name})):[]},[a,m]),j=l.useMemo(()=>function({row:t,column:s,autoFocus:i=!1}){return n.jsx("input",{ref:i?E:null,defaultValue:t.original[s.id]??"",className:"w-full min-w-[120px] px-2 py-1 border rounded text-sm",onBlur:r=>h(t.original.id??t.original.__tempId,s.id,r.target.value)})},[h]),v=l.useMemo(()=>function({row:t,column:s}){return n.jsx("input",{defaultValue:t.original[s.id]??"",className:"w-full min-w-[180px] px-2 py-1 border rounded text-sm",onBlur:i=>{const r=i.target.value.trim();if(r&&!/^\d{10,15}$/.test(r)){d.error("Phone must be 10-15 digits");return}h(t.original.id??t.original.__tempId,s.id,r)}})},[h]),Y=l.useMemo(()=>[{id:"row_no",header:"#",cell:({row:e})=>e.index+1},{accessorKey:"name",header:"Name",enableSorting:!0,cell:({row:e,column:t,table:s})=>n.jsx(j,{row:e,column:t,autoFocus:e.original.__isNew&&e.original.__tempId===s.options.meta.pendingFocusId})},{accessorKey:"father_name",header:"Father",cell:({row:e,column:t})=>n.jsx(j,{row:e,column:t})},{accessorKey:"father_phone",header:"Father Phone",cell:({row:e,column:t})=>n.jsx(v,{row:e,column:t})},{accessorKey:"mother_phone",header:"Mother Phone",cell:({row:e,column:t})=>n.jsx(v,{row:e,column:t})},{header:"Enrollments",cell:({row:e,table:t})=>{const{classes:s,sectionsByClass:i,loadSections:r,setData:ne,setIsDirty:re}=t.options.meta;return n.jsx(ie,{row:e,classes:s,sectionsByClass:i,loadSections:r,setData:ne,setIsDirty:re})}},{header:"Actions",cell:({row:e})=>n.jsx("button",{className:"text-red-600 text-sm",onClick:()=>{if(confirm("Delete this student? All enrollments will be removed.")){const t=e.original.id;if(!t){const s=e.original.__tempId??e.original.id;c(i=>i.filter(r=>(r.id??r.__tempId)!==s)),u(!0);return}A.delete(`/admin/students/${t}`,{preserveScroll:!0,onSuccess:()=>{S().then(s=>{if(s?.some(r=>String(r.id)===String(t))){d.error("Delete failed. Student still exists.");return}d.success("Student deleted")})},onError:()=>d.error("Failed to delete student")})}},children:"Delete"})}],[v,j]),Z=l.useMemo(()=>o.filter(e=>!(a!=="all"&&!e.enrollments?.some(s=>String(s.class_id)===String(a))||f!=="all"&&!e.enrollments?.some(s=>String(s.section_id)===String(f))||p!=="all"&&!e.enrollments?.some(s=>p==="free"?s.student_type==="free":s.student_type!=="free"))),[o,a,f,p]),z=oe({data:Z,columns:Y,getRowId:e=>e.id?`student-${e.id}`:e.__tempId,meta:{classes:_,sectionsByClass:m,loadSections:Q,setData:c,setIsDirty:u,pendingFocusId:b},state:{sorting:L,globalFilter:w,columnFilters:q},filterFns:O,onSortingChange:K,onGlobalFilterChange:C,getCoreRowModel:ue(),getFilteredRowModel:ce(),getSortedRowModel:de(),globalFilterFn:"includesString"});function ee(){if(!F)return;if(o.some(s=>s.__isNew&&!s.name?.trim())){d.error("Finish the current new student first");return}const t=T();c(s=>[{id:null,__tempId:t,name:"",father_name:"",father_phone:"",mother_phone:"",status:"active",enrollments:[],__isNew:!0},...s]),u(!0),k(t)}function te(e){if(!e.name?.trim())return"Student name is required";if(!e.enrollments?.length)return"At least one enrollment required";const t=new Set;for(const s of e.enrollments){if(!s.class_id||!s.section_id)return"Each enrollment needs class & section";const i=`${s.class_id}-${s.section_id}`;if(t.has(i))return"Duplicate class + section enrollment";t.add(i)}return null}function se(){if(!D||y.current)return;const e=[],t=[];if(o.forEach((s,i)=>{const r=te(s);r?e.push(`Row ${i+1}: ${r}`):t.push(s)}),e.length){d.error(n.jsxs("div",{children:[n.jsx("strong",{children:"Fix these issues:"}),n.jsx("ul",{className:"list-disc ml-4 mt-1",children:e.slice(0,5).map((s,i)=>n.jsx("li",{children:s},i))})]}),{duration:6e3});return}I(!0),y.current=!0,A.post("/admin/students/bulk-update",{students:t},{preserveScroll:!0,onSuccess:()=>{d.success("Changes saved"),u(!1),S()},onFinish:()=>{I(!1),y.current=!1}})}return n.jsxs(le,{title:"Students",children:[n.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-center justify-between",children:[n.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[n.jsx("input",{className:"px-3 py-2 border rounded text-sm w-64",placeholder:"Search...",value:w,onChange:e=>C(e.target.value)}),n.jsxs("select",{value:a,onChange:e=>G(e.target.value),className:"px-3 py-2 border rounded text-sm",children:[n.jsx("option",{value:"all",children:"All Classes"}),_.map(e=>n.jsx("option",{value:String(e.id),children:e.name},e.id))]}),n.jsxs("select",{value:f,onChange:e=>H(e.target.value),disabled:a==="all",className:"px-3 py-2 border rounded text-sm disabled:bg-gray-100",children:[n.jsx("option",{value:"all",children:a==="all"?"Select class first":"All Sections"}),X.map(e=>n.jsx("option",{value:e.id,children:e.name},e.id))]}),n.jsxs("select",{value:p,onChange:e=>V(e.target.value),className:"px-3 py-2 border rounded text-sm",children:[n.jsx("option",{value:"all",children:"Paid & Free"}),n.jsx("option",{value:"paid",children:"Paid"}),n.jsx("option",{value:"free",children:"Free"})]}),n.jsx("button",{onClick:J,className:"px-3 py-2 border rounded text-sm",children:"Reset"})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("button",{onClick:ee,disabled:!F,className:"px-4 py-2 bg-blue-600 text-white rounded text-sm disabled:opacity-50",children:"+ Add Student"}),n.jsx("button",{onClick:se,disabled:!D||x,className:`px-4 py-2 rounded text-sm text-white ${x?"bg-green-400":"bg-green-600 hover:bg-green-700"} disabled:opacity-50`,children:x?"Saving...":"Save Changes"})]})]}),g?n.jsx(me,{text:"Loading students..."}):n.jsx("div",{className:"bg-white border rounded overflow-x-auto",children:n.jsxs("table",{className:"min-w-[900px] text-sm",children:[n.jsx("thead",{className:"bg-gray-50",children:z.getHeaderGroups().map(e=>n.jsx("tr",{children:e.headers.map(t=>n.jsxs("th",{ref:t.column.id==="row_no"?M:null,className:`px-3 py-2 cursor-pointer select-none ${t.column.id==="row_no"?"sticky left-0 z-30 bg-gray-50":t.column.id==="name"?"sticky z-30 bg-gray-50 whitespace-nowrap":""}`,style:t.column.id==="name"?{left:`${$}px`}:void 0,onClick:t.column.getToggleSortingHandler(),children:[P(t.column.columnDef.header,t.getContext()),{asc:" â–²",desc:" â–¼"}[t.column.getIsSorted()]??""]},t.id))},e.id))}),n.jsx("tbody",{children:z.getRowModel().rows.map(e=>n.jsx("tr",{className:"border-b",children:e.getVisibleCells().map(t=>n.jsx("td",{className:`px-3 py-2 border-b align-top ${t.column.id==="row_no"?"sticky left-0 z-20 bg-white":t.column.id==="name"?"sticky z-20 bg-white whitespace-nowrap":""}`,style:t.column.id==="name"?{left:`${$}px`}:void 0,children:P(t.column.columnDef.cell,t.getContext())},t.id))},e.id))})]})})]})}export{ye as default};
