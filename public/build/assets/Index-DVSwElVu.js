import{j as s,r as l,z as m,a as X}from"./app-uqy2rxhF.js";import{A as Y}from"./AdminLayout-BZ-qH-wv.js";import Z from"./EnrollmentsCell-BkIHMlP9.js";import ee from"./useStudentFilters-dSXcA75z.js";import{u as te,f as M,g as se,a as ne,b as re}from"./index-CQ1a7iw2.js";function le({text:o="Loading..."}){return s.jsx("div",{className:"relative min-h-[300px] bg-white border rounded-lg",children:s.jsx("div",{className:"absolute inset-0 z-30 bg-white/80 flex items-center justify-center",children:s.jsxs("div",{className:"flex flex-col items-center gap-3",children:[s.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-gray-300 border-t-blue-600"}),s.jsx("p",{className:"text-sm text-gray-600",children:o})]})})})}function ue(){const[o,d]=l.useState([]),[h,E]=l.useState([]),[c,$]=l.useState({}),[P,I]=l.useState([]),[v,_]=l.useState(""),[p,N]=l.useState(!0),[C,w]=l.useState(!1),[F,u]=l.useState(!1),[g,R]=l.useState(!1),b=l.useRef(!1),j=l.useRef(null),{classFilter:i,sectionFilter:f,feeFilter:x,setClassFilter:U,setSectionFilter:T,setFeeFilter:B,columnFilters:L,filterFns:z,resetFilters:K}=ee();l.useEffect(()=>{k()},[]);function k(){N(!0),w(!1),Promise.all([fetch("/admin/students/data").then(e=>e.json()),fetch("/admin/classes/options").then(e=>e.json())]).then(([e,t])=>{const n=e.map(r=>({...r,enrollments:(r.enrollments||[]).map(a=>({id:a.id??crypto.randomUUID(),class_id:String(a.class_id??""),section_id:String(a.section_id??""),student_type:a.student_type??"paid"}))}));d(n),E(t)}).catch(()=>m.error("Failed to load students")).finally(()=>N(!1))}l.useEffect(()=>{if(!p){const e=setTimeout(()=>w(!0),300);return()=>clearTimeout(e)}},[p]);function S(e,t,n){d(r=>r.map((a,W)=>W===e?{...a,[t]:n}:a)),u(!0)}function V(e){if(!e)return;const t=String(e);c[t]||fetch(`/admin/sections/options?class_id=${e}`).then(n=>n.json()).then(n=>$(r=>({...r,[t]:n})))}const q=l.useMemo(()=>{if(i==="all")return[];const e=c[String(i)];return Array.isArray(e)?e.map(t=>({id:String(t.id),name:t.name})):[]},[i,c]);function D({row:e,column:t}){return s.jsx("input",{defaultValue:e.original[t.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:n=>{const r=n.target.value.trim();if(r&&!/^\d{10,15}$/.test(r)){m.error("Phone must be 10–15 digits");return}S(e.index,t.id,r)}})}const G=l.useMemo(()=>[{header:"#",cell:({row:e})=>e.index+1},{accessorKey:"name",header:"Name",enableSorting:!0,cell:({row:e,column:t})=>s.jsx(y,{row:e,column:t,autoFocus:e.original.__isNew})},{accessorKey:"father_name",header:"Father",cell:({row:e,column:t})=>s.jsx(y,{row:e,column:t})},{accessorKey:"father_phone",header:"Father Phone",cell:({row:e,column:t})=>s.jsx(D,{row:e,column:t})},{accessorKey:"mother_phone",header:"Mother Phone",cell:({row:e,column:t})=>s.jsx(D,{row:e,column:t})},{header:"Enrollments",cell:({row:e})=>s.jsx(Z,{row:e,classes:h,sectionsByClass:c,loadSections:V,setData:d,setIsDirty:u})},{header:"Actions",cell:({row:e})=>s.jsx("button",{className:"text-red-600 text-sm",onClick:()=>{confirm("Delete this student? All enrollments will be removed.")&&(d(t=>t.filter((n,r)=>r!==e.index)),u(!0))},children:"Delete"})}],[h,c]),H=l.useMemo(()=>o.filter(e=>!(i!=="all"&&!e.enrollments?.some(n=>String(n.class_id)===String(i))||f!=="all"&&!e.enrollments?.some(n=>String(n.section_id)===String(f))||x!=="all"&&!e.enrollments?.some(n=>x==="free"?n.student_type==="free":n.student_type!=="free"))),[o,i,f,x]),A=te({data:H,columns:G,getRowId:e=>e.id?`student-${e.id}`:e.__tempId,state:{sorting:P,globalFilter:v,columnFilters:L},filterFns:z,onSortingChange:I,onGlobalFilterChange:_,getCoreRowModel:re(),getFilteredRowModel:ne(),getSortedRowModel:se(),globalFilterFn:"includesString"});function O(){if(!C)return;if(o.some(t=>t.__isNew&&!t.name?.trim())){m.error("Finish the current new student first");return}d(t=>[{id:null,__tempId:crypto.randomUUID(),name:"",father_name:"",father_phone:"",mother_phone:"",status:"active",enrollments:[],__isNew:!0},...t]),u(!0),requestAnimationFrame(()=>{j.current?.focus()})}function J(e){if(!e.name?.trim())return"Student name is required";if(!e.enrollments?.length)return"At least one enrollment required";const t=new Set;for(const n of e.enrollments){if(!n.class_id||!n.section_id)return"Each enrollment needs class & section";const r=`${n.class_id}-${n.section_id}`;if(t.has(r))return"Duplicate class + section enrollment";t.add(r)}return null}function Q(){if(!F||b.current)return;const e=[],t=[];if(o.forEach((n,r)=>{const a=J(n);a?e.push(`Row ${r+1}: ${a}`):t.push(n)}),e.length){m.error(s.jsxs("div",{children:[s.jsx("strong",{children:"Fix these issues:"}),s.jsx("ul",{className:"list-disc ml-4 mt-1",children:e.slice(0,5).map((n,r)=>s.jsx("li",{children:n},r))})]}),{duration:6e3});return}R(!0),b.current=!0,X.post("/admin/students/bulk-update",{students:t},{preserveScroll:!0,onSuccess:()=>{m.success("Changes saved"),u(!1),k()},onFinish:()=>{R(!1),b.current=!1}})}function y({row:e,column:t,autoFocus:n=!1}){return s.jsx("input",{ref:n?j:null,defaultValue:e.original[t.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:r=>S(e.index,t.id,r.target.value)})}return s.jsxs(Y,{title:"Students",children:[s.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-center justify-between",children:[s.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[s.jsx("input",{className:"px-3 py-2 border rounded text-sm w-64",placeholder:"Search…",value:v,onChange:e=>_(e.target.value)}),s.jsxs("select",{value:i,onChange:e=>U(e.target.value),className:"px-3 py-2 border rounded text-sm",children:[s.jsx("option",{value:"all",children:"All Classes"}),h.map(e=>s.jsx("option",{value:String(e.id),children:e.name},e.id))]}),s.jsxs("select",{value:f,onChange:e=>T(e.target.value),disabled:i==="all",className:"px-3 py-2 border rounded text-sm disabled:bg-gray-100",children:[s.jsx("option",{value:"all",children:i==="all"?"Select class first":"All Sections"}),q.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),s.jsxs("select",{value:x,onChange:e=>B(e.target.value),className:"px-3 py-2 border rounded text-sm",children:[s.jsx("option",{value:"all",children:"Paid & Free"}),s.jsx("option",{value:"paid",children:"Paid"}),s.jsx("option",{value:"free",children:"Free"})]}),s.jsx("button",{onClick:K,className:"px-3 py-2 border rounded text-sm",children:"Reset"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:O,disabled:!C,className:"px-4 py-2 bg-blue-600 text-white rounded text-sm disabled:opacity-50",children:"+ Add Student"}),s.jsx("button",{onClick:Q,disabled:!F||g,className:`px-4 py-2 rounded text-sm text-white ${g?"bg-green-400":"bg-green-600 hover:bg-green-700"} disabled:opacity-50`,children:g?"Saving…":"Save Changes"})]})]}),p?s.jsx(le,{text:"Loading students…"}):s.jsx("div",{className:"bg-white border rounded overflow-x-auto",children:s.jsxs("table",{className:"min-w-[900px] text-sm",children:[s.jsx("thead",{className:"bg-gray-50",children:A.getHeaderGroups().map(e=>s.jsx("tr",{children:e.headers.map(t=>s.jsxs("th",{className:"px-3 py-2 cursor-pointer select-none",onClick:t.column.getToggleSortingHandler(),children:[M(t.column.columnDef.header,t.getContext()),{asc:" ▲",desc:" ▼"}[t.column.getIsSorted()]??""]},t.id))},e.id))}),s.jsx("tbody",{children:A.getRowModel().rows.map(e=>s.jsx("tr",{className:"border-b",children:e.getVisibleCells().map(t=>s.jsx("td",{className:`px-3 py-2 min-${t.column.columnDef.header==="#"?"w-auto":"w-[150px]"} border-b align-top`,children:M(t.column.columnDef.cell,t.getContext())},t.id))},e.id))})]})})]})}export{ue as default};
