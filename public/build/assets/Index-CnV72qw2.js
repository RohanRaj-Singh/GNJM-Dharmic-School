import{r as c,j as s,z as l,a as k}from"./app-C_YOFr3M.js";import{A as M}from"./AdminLayout-Cja4yVUZ.js";import{u as $,f as j,g as O,a as T,b as D}from"./index-Cpk4Id2Y.js";import"./logo-CAn8f4K1.js";function L(){const[m,x]=c.useState([]),[y,N]=c.useState([]),[f,p]=c.useState(""),[a,r]=c.useState({open:!1,classId:null,className:"",periods:[],editingId:null,amount:0,effective_from:"",effective_to:"",sectionOptions:[],resetSectionIds:[]}),h=c.useRef(null);function g(){fetch("/admin/classes/data").then(e=>e.json()).then(x)}c.useEffect(g,[]);function v(e,t,i){x(n=>n.map((o,d)=>d===e?{...o,[t]:i}:o))}function _({row:e,column:t,autoFocus:i=!1}){const n=i?h:null;return s.jsx("input",{ref:n,defaultValue:e.original[t.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:o=>v(e.index,t.id,o.target.value)})}async function u(e){if(!e.original.id){l.error("Save class first, then configure fee timeline");return}try{const[t,i]=await Promise.all([window.axios.get(`/admin/classes/${e.original.id}/fee-periods`,{headers:{Accept:"application/json"}}),window.axios.get(`/admin/sections/options?class_id=${e.original.id}&include_meta=1`,{headers:{Accept:"application/json"}})]),n=t?.data??{},o=(i?.data??[]).map(d=>({...d,has_timeline:!!d?.has_timeline}));r({open:!0,classId:e.original.id,className:e.original.name,periods:n.periods??[],editingId:null,amount:0,effective_from:"",effective_to:"",sectionOptions:o,resetSectionIds:[]})}catch{l.error("Failed to load fee timeline")}}async function w(){if(!a.effective_from){l.error("Start month is required");return}const e=a.editingId?`/admin/classes/${a.classId}/fee-periods/${a.editingId}`:`/admin/classes/${a.classId}/fee-periods`,t=a.editingId?"PUT":"POST";try{const n=(await window.axios.request({url:e,method:t.toLowerCase(),headers:{Accept:"application/json"},data:{amount:Number(a.amount||0),effective_from:a.effective_from,effective_to:a.effective_to||null,reset_section_ids:a.resetSectionIds}}))?.data?.section_sync;if((n?.updated??0)>0){const o=(n?.timelines_zeroed??0)>0?`, and zeroed ${n.timelines_zeroed} section timeline period(s)`:"";l.success(`Updated ${n.updated} section legacy fee(s) to Rs. 0${o}`)}await u({original:{id:a.classId,name:a.className}}),l.success("Fee period saved")}catch(i){const n=i?.response?.data,o=n?.message||Object.values(n?.errors??{}).flat()?.[0]||i?.message;l.error(o||"Could not save period")}}async function C(e){if(confirm("Delete this fee period?"))try{await window.axios.delete(`/admin/classes/${a.classId}/fee-periods/${e}`,{headers:{Accept:"application/json"}}),await u({original:{id:a.classId,name:a.className}}),l.success("Fee period deleted")}catch(t){const i=t?.response?.data,n=i?.message||Object.values(i?.errors??{}).flat()?.[0]||t?.message;l.error(n||"Could not delete period")}}function S(e){r(t=>({...t,editingId:e.id,amount:e.amount,effective_from:e.effective_from,effective_to:e.effective_to??""}))}function I(e,t){r(i=>{const n=new Set(i.resetSectionIds??[]);return t?n.add(Number(e)):n.delete(Number(e)),{...i,resetSectionIds:Array.from(n)}})}const R=c.useMemo(()=>[{accessorKey:"name",header:"Class Name",cell:({row:e,column:t})=>s.jsx(_,{row:e,column:t,autoFocus:e.original.__isNew})},{accessorKey:"default_monthly_fee",header:"Legacy Monthly Fee",cell:({row:e})=>s.jsxs("span",{className:"text-gray-500",children:["Rs. ",e.original.default_monthly_fee??0]})},{accessorKey:"sections_count",header:"Sections",cell:({row:e})=>s.jsx("span",{className:"text-gray-600",children:e.original.sections_count??0})},{header:"Fee Timeline",cell:({row:e})=>s.jsx("button",{onClick:()=>u(e),className:"px-2 py-1 text-xs bg-slate-700 text-white rounded",children:"Manage"})}],[]),b=$({data:m,columns:R,getRowId:e=>e.id?`class-${e.id}`:e.__tempId,state:{sorting:y,globalFilter:f},onSortingChange:N,onGlobalFilterChange:p,getCoreRowModel:D(),getFilteredRowModel:T(),getSortedRowModel:O(),globalFilterFn:"includesString"});function F(){const e={id:null,__tempId:crypto.randomUUID(),name:"",default_monthly_fee:0,sections_count:0,__isNew:!0};x(t=>[e,...t]),requestAnimationFrame(()=>{h.current?.focus()})}function A(){if(m.some(e=>!e.name?.trim())){l.error("Class name cannot be empty");return}k.post("/admin/classes/save",{classes:m},{onSuccess:()=>{l.success("Classes saved"),g()},onError:()=>l.error("Save failed")})}return s.jsxs(M,{title:"Classes",children:[s.jsxs("div",{className:"flex flex-wrap justify-between gap-3 mb-4",children:[s.jsx("input",{className:"px-3 py-2 border rounded text-sm w-64",placeholder:"Search classes...",value:f,onChange:e=>p(e.target.value)}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:F,className:"px-4 py-2 bg-blue-600 text-white rounded",children:"+ Add Class"}),s.jsx("button",{onClick:A,className:"px-4 py-2 bg-green-600 text-white rounded",children:"Save Changes"})]})]}),s.jsx("div",{className:"bg-white border rounded overflow-auto",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"bg-gray-50 border-b",children:b.getHeaderGroups().map(e=>s.jsx("tr",{children:e.headers.map(t=>s.jsxs("th",{className:"px-3 py-2 text-left font-medium cursor-pointer",onClick:t.column.getToggleSortingHandler(),children:[j(t.column.columnDef.header,t.getContext()),{asc:" ↑",desc:" ↓"}[t.column.getIsSorted()]??""]},t.id))},e.id))}),s.jsx("tbody",{children:b.getRowModel().rows.map(e=>s.jsx("tr",{className:"border-b hover:bg-gray-50",children:e.getVisibleCells().map(t=>s.jsx("td",{className:"px-3 py-2",children:j(t.column.columnDef.cell,t.getContext())},t.id))},e.id))})]})}),a.open&&s.jsx("div",{className:"fixed inset-0 z-40 bg-black/40 flex items-center justify-center p-4",children:s.jsxs("div",{className:"bg-white rounded shadow-xl w-full max-w-2xl p-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-3",children:[s.jsxs("h3",{className:"font-semibold",children:["Class Fee Timeline: ",a.className]}),s.jsx("button",{onClick:()=>r(e=>({...e,open:!1})),className:"text-sm text-gray-500",children:"Close"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-2 mb-3",children:[s.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 text-sm",placeholder:"Amount",value:a.amount,onChange:e=>r(t=>({...t,amount:Number(e.target.value||0)}))}),s.jsx("input",{type:"month",className:"border rounded px-2 py-1 text-sm",value:a.effective_from,onChange:e=>r(t=>({...t,effective_from:e.target.value}))}),s.jsx("input",{type:"month",className:"border rounded px-2 py-1 text-sm",value:a.effective_to,onChange:e=>r(t=>({...t,effective_to:e.target.value}))}),s.jsx("button",{onClick:w,className:"bg-blue-600 text-white rounded px-3 py-1 text-sm",children:a.editingId?"Update":"Add"})]}),s.jsxs("div",{className:"mb-3 border rounded p-3 bg-amber-50/40",children:[s.jsx("p",{className:"text-sm font-medium text-slate-800 mb-1",children:"Optional: reset section legacy fee to inherit class"}),s.jsxs("p",{className:"text-xs text-slate-600 mb-2",children:["Selected sections will get legacy fee ",s.jsx("span",{className:"font-semibold",children:"Rs. 0"}),". Section timelines still override class where configured."]}),s.jsx("div",{className:"max-h-36 overflow-auto space-y-1",children:(a.sectionOptions??[]).length===0?s.jsx("p",{className:"text-xs text-gray-500",children:"No sections found for this class."}):a.sectionOptions.map(e=>s.jsxs("label",{className:"flex items-center justify-between gap-2 text-xs border rounded px-2 py-1 bg-white",children:[s.jsxs("span",{children:[e.name," ",s.jsxs("span",{className:"text-gray-500",children:["(Legacy: Rs. ",e.monthly_fee??0,")"]})]}),s.jsxs("span",{className:"flex items-center gap-2",children:[e.has_timeline?s.jsx("span",{className:"text-amber-700",children:"Has timeline"}):s.jsx("span",{className:"text-emerald-700",children:"No timeline"}),s.jsx("input",{type:"checkbox",checked:(a.resetSectionIds??[]).includes(Number(e.id)),onChange:t=>I(e.id,t.target.checked)})]})]},e.id))})]}),s.jsx("div",{className:"border rounded max-h-80 overflow-auto",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"bg-gray-50",children:s.jsxs("tr",{children:[s.jsx("th",{className:"text-left px-3 py-2",children:"From"}),s.jsx("th",{className:"text-left px-3 py-2",children:"To"}),s.jsx("th",{className:"text-left px-3 py-2",children:"Amount"}),s.jsx("th",{className:"text-left px-3 py-2",children:"Action"})]})}),s.jsxs("tbody",{children:[a.periods.map(e=>s.jsxs("tr",{className:"border-t",children:[s.jsx("td",{className:"px-3 py-2",children:e.effective_from}),s.jsx("td",{className:"px-3 py-2",children:e.effective_to??"Open"}),s.jsxs("td",{className:"px-3 py-2",children:["Rs. ",e.amount]}),s.jsxs("td",{className:"px-3 py-2 space-x-2",children:[s.jsx("button",{onClick:()=>S(e),className:"text-blue-600 text-xs",children:"Edit"}),s.jsx("button",{onClick:()=>C(e.id),className:"text-red-600 text-xs",children:"Delete"})]})]},e.id)),a.periods.length===0&&s.jsx("tr",{children:s.jsx("td",{colSpan:4,className:"px-3 py-3 text-gray-500",children:"No fee periods configured."})})]})]})})]})})]})}export{L as default};
