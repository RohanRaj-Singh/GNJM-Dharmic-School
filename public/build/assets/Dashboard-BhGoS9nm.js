import{r as x,j as e}from"./app-C_YOFr3M.js";import{A as L}from"./AdminLayout-Cja4yVUZ.js";import{f as b}from"./helper-BxvJq_M8.js";import"./logo-CAn8f4K1.js";function t(r){const c=Number(r);return Number.isFinite(c)?c:0}function y(r){const c=String(r?.name??"").trim();return c.length?c:`Class #${t(r?.id)}`}function _(r,c){return`${t(r)} (Free: ${t(c)})`}function m({label:r,value:c,sub:f,accent:h="bg-slate-700"}){return e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:r}),e.jsx("span",{className:`h-2.5 w-2.5 rounded-full ${h}`})]}),e.jsx("p",{className:"text-xl font-semibold text-slate-800",children:c}),f?e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:f}):null]})}function E({label:r,value:c,total:f,tone:h="bg-blue-600",suffix:j=""}){const n=t(c),v=t(f),g=v>0?Math.max(0,Math.min(100,Math.round(n/v*100))):0;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1",children:[e.jsx("span",{className:"text-slate-600",children:r}),e.jsxs("span",{className:"font-medium text-slate-800",children:[c,j]})]}),e.jsx("div",{className:"h-2 rounded-full bg-slate-100 overflow-hidden",children:e.jsx("div",{className:`h-full ${h}`,style:{width:`${g}%`}})})]})}function I(){const r=new Date().getFullYear(),[c,f]=x.useState(String(r)),[h,j]=x.useState(!0),[n,v]=x.useState(null),[g,w]=x.useState(""),[u,C]=x.useState("gurmukhi"),[o,N]=x.useState("all"),[i,p]=x.useState("all");x.useEffect(()=>{j(!0),w(""),fetch(`/admin/dashboard/summary?year=${c}`).then(async s=>{if(!s.ok)throw new Error("Failed to load dashboard summary");return s.json()}).then(s=>{v(s),(s?.divisions??[]).some(a=>a.type===u)||C(s?.divisions?.[0]?.type??"gurmukhi")}).catch(s=>{w(s.message||"Unable to load dashboard data")}).finally(()=>j(!1))},[c]);const l=x.useMemo(()=>(n?.divisions??[]).find(s=>s.type===u)??null,[n,u]),d=x.useMemo(()=>!l||o==="all"?null:l.classes.find(s=>String(s.id)===String(o))??null,[l,o]),$=d?d.sections:[],F=i==="all"?$:$.filter(s=>String(s.id)===String(i)),A=x.useMemo(()=>{if(!d)return{students:0,freeStudents:0};if(i==="all")return{students:t(d.students_count),freeStudents:t(d.free_students_count)};const s=d.sections.find(a=>String(a.id)===String(i))??null;return{students:t(s?.students_count),freeStudents:t(s?.free_students_count)}},[d,i]);x.useEffect(()=>{if(!l){N("all"),p("all");return}o!=="all"&&!l.classes.some(s=>String(s.id)===String(o))&&(N("all"),p("all"))},[l,o]),x.useEffect(()=>{if(!d){p("all");return}i!=="all"&&!d.sections.some(s=>String(s.id)===String(i))&&p("all")},[d,i]);const M=x.useMemo(()=>(n?.insights?.top_absentees??[]).filter(a=>a.division_type===u).filter(a=>o==="all"||String(a.class_id)===String(o)).filter(a=>i==="all"||String(a.section_id)===String(i)).sort((a,S)=>t(S.absent_days)-t(a.absent_days)),[n,u,o,i]),D=x.useMemo(()=>(n?.insights?.top_pending_fees??[]).filter(a=>a.division_type===u).filter(a=>o==="all"||String(a.class_id)===String(o)).filter(a=>i==="all"||String(a.section_id)===String(i)).sort((a,S)=>t(S.pending_amount)-t(a.pending_amount)),[n,u,o,i]);return e.jsx(L,{title:"Dashboard",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-white border rounded-xl px-4 py-3",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-semibold text-slate-800",children:"School Admin Dashboard"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Fees, attendance and division performance in one operational view."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs uppercase text-slate-500",children:"Year"}),e.jsx("select",{value:c,onChange:s=>f(s.target.value),className:"border rounded-md px-2 py-1.5 text-sm",children:[r-2,r-1,r,r+1].map(s=>e.jsx("option",{value:String(s),children:s},s))})]})]})}),h?e.jsx("div",{className:"bg-white border rounded-xl p-6 text-sm text-slate-500",children:"Loading dashboard..."}):null,!h&&g?e.jsx("div",{className:"bg-white border rounded-xl p-6 text-sm text-rose-600",children:g}):null,!h&&!g&&n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-3",children:[e.jsx(m,{label:"Total Fees",value:b(t(n.fees.total)),accent:"bg-blue-600"}),e.jsx(m,{label:"Collected",value:b(t(n.fees.collected)),accent:"bg-emerald-600"}),e.jsx(m,{label:"Pending",value:b(t(n.fees.pending)),accent:"bg-rose-600"}),e.jsx(m,{label:"Collection Rate",value:`${t(n.fees.percentage)}%`,sub:"Collected / Total",accent:"bg-violet-600"}),e.jsx(m,{label:"Active Students",value:t(n.students.active),sub:`${t(n.students.total)} total students`,accent:"bg-amber-500"})]}),e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 mb-4",children:[e.jsx("div",{className:"inline-flex border rounded-lg p-1 bg-slate-50",children:(n.divisions??[]).map(s=>e.jsx("button",{onClick:()=>{C(s.type),N("all"),p("all")},className:`px-3 py-1.5 rounded-md text-sm border ${u===s.type?"bg-emerald-600 border-emerald-600 text-white":"bg-white border-slate-200 text-slate-700 hover:bg-slate-100"}`,children:s.title},s.type))}),l?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:o,onChange:s=>{N(s.target.value),p("all")},className:"border rounded-md px-2 py-1.5 text-sm min-w-[220px] bg-white text-slate-800",children:[e.jsxs("option",{value:"all",children:["All Classes (",l.title,")"]}),l.classes.map(s=>e.jsx("option",{value:String(s.id),children:y(s)},s.id))]}),e.jsxs("select",{value:i,onChange:s=>p(s.target.value),disabled:!d,className:"border rounded-md px-2 py-1.5 text-sm min-w-[220px] bg-white text-slate-800 disabled:bg-slate-100",children:[e.jsx("option",{value:"all",children:d?`All Sections (${y(d)})`:"Select class first"}),(d?.sections??[]).map(s=>e.jsx("option",{value:String(s.id),children:s.name},s.id))]})]}):null]}),l?e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"xl:col-span-1 border rounded-lg p-3 bg-slate-50/60",children:[e.jsxs("p",{className:"text-xs uppercase text-slate-500 mb-3",children:[l.title," Overview"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(E,{label:"Division Fee Collection",value:t(l.fees.collected),total:Math.max(1,t(l.fees.total)),tone:"bg-emerald-600",suffix:""}),e.jsx(E,{label:"Division Attendance (Present %)",value:t(l.attendance.percentage),total:100,tone:"bg-blue-600",suffix:"%"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 pt-1",children:[e.jsx(m,{label:"Classes",value:t(l.stats.classes_count),accent:"bg-slate-600"}),e.jsx(m,{label:"Sections",value:t(l.stats.sections_count),accent:"bg-slate-600"}),e.jsx(m,{label:"Students",value:t(l.stats.students_count),accent:"bg-amber-500"}),e.jsx(m,{label:"Active",value:t(l.stats.active_students_count),accent:"bg-emerald-600"})]})]})]}),e.jsxs("div",{className:"xl:col-span-2 space-y-4",children:[e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-3 py-2 bg-slate-50 border-b text-sm font-medium text-slate-700",children:"Class Performance"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-white border-b text-slate-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-3 py-2",children:"Class"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Students (Free)"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Fees"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Collection %"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Attendance %"})]})}),e.jsx("tbody",{children:l.classes.filter(s=>o==="all"||String(s.id)===String(o)).map(s=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"px-3 py-2 font-medium text-slate-800",children:y(s)}),e.jsx("td",{className:"px-3 py-2",children:_(s.students_count,s.free_students_count)}),e.jsx("td",{className:"px-3 py-2",children:b(t(s.fees.total))}),e.jsxs("td",{className:"px-3 py-2",children:[t(s.fees.percentage),"%"]}),e.jsxs("td",{className:"px-3 py-2",children:[t(s.attendance.percentage),"%"]})]},s.id))})]})})]}),o!=="all"?e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"px-3 py-2 bg-slate-50 border-b text-sm font-medium text-slate-700",children:["Section Summary"," ",d?`- ${y(d)}`:"",i!=="all"?` / ${d?.sections.find(s=>String(s.id)===String(i))?.name??"Selected Section"}`:"",e.jsxs("span",{className:"ml-2 text-xs font-normal text-slate-500",children:["Students:"," ",_(A.students,A.freeStudents)]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-white border-b text-slate-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-3 py-2",children:"Section"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Students (Free)"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Fees"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Collection %"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Attendance %"})]})}),e.jsxs("tbody",{children:[F.map(s=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"px-3 py-2 font-medium text-slate-800",children:s.name}),e.jsx("td",{className:"px-3 py-2",children:_(s.students_count,s.free_students_count)}),e.jsx("td",{className:"px-3 py-2",children:b(t(s.fees.total))}),e.jsxs("td",{className:"px-3 py-2",children:[t(s.fees.percentage),"%"]}),e.jsxs("td",{className:"px-3 py-2",children:[t(s.attendance.percentage),"%"]})]},s.id)),F.length===0?e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-slate-400",colSpan:5,children:"No sections found for this class."})}):null]})]})})]}):e.jsx("div",{className:"border rounded-lg p-3 bg-slate-50 text-sm text-slate-500",children:"Select a class to view section-level summaries."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-3 py-2 bg-slate-50 border-b text-sm font-medium text-slate-700",children:"Most Absent Students"}),e.jsx("div",{className:"max-h-72 overflow-y-auto",children:M.length===0?e.jsx("p",{className:"px-3 py-4 text-sm text-slate-400",children:"No absent-student data for this filter."}):M.slice(0,20).map(s=>e.jsxs("div",{className:"px-3 py-2 border-b text-sm",children:[e.jsx("div",{className:"font-medium text-slate-800",children:s.student_name}),e.jsxs("div",{className:"text-xs text-slate-500",children:[s.class_name,s.section_name?` / ${s.section_name}`:""," ",s.father_name?`• Father: ${s.father_name}`:""]}),e.jsxs("div",{className:"text-xs text-rose-700 font-semibold mt-1",children:[t(s.absent_days)," absent day(s)"]})]},`${s.enrollment_id}-abs`))})]}),e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-3 py-2 bg-slate-50 border-b text-sm font-medium text-slate-700",children:"Highest Pending Fees"}),e.jsx("div",{className:"max-h-72 overflow-y-auto",children:D.length===0?e.jsx("p",{className:"px-3 py-4 text-sm text-slate-400",children:"No pending-fee data for this filter."}):D.slice(0,20).map(s=>e.jsxs("div",{className:"px-3 py-2 border-b text-sm",children:[e.jsx("div",{className:"font-medium text-slate-800",children:s.student_name}),e.jsxs("div",{className:"text-xs text-slate-500",children:[s.class_name,s.section_name?` / ${s.section_name}`:""," ",s.father_name?`• Father: ${s.father_name}`:""]}),e.jsxs("div",{className:"text-xs text-amber-700 font-semibold mt-1",children:[b(t(s.pending_amount))," pending (",t(s.pending_fee_count)," fee item(s))"]})]},`${s.enrollment_id}-fee`))})]})]})]})]}):e.jsx("div",{className:"text-sm text-slate-500",children:"No division data found."})]}),e.jsxs("div",{className:"text-xs text-right text-slate-400",children:["Last updated: ",n.meta.generated_at]})]}):null]})})}export{I as default};
