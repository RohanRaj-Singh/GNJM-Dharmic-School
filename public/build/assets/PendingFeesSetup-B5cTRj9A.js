import{u as A,r as n,j as e,a as j,z as p}from"./app-CKCcpFSt.js";import{A as P}from"./AdminLayout-DVIreQcb.js";function L(){const{rows:d=[],filters:l={},classes:v=[],sections:S=[]}=A().props,[r,h]=n.useState({}),[u,f]=n.useState({}),[_,g]=n.useState(l?.search??"");n.useEffect(()=>{const s={};d.forEach(t=>{s[t.id]=t.assumed_pending_months??0}),h(s),f(s)},[d]);const o=l.class_id??"",w=l.section_id??"";l.search;function x(s,t){j.get(route("admin.utilities.pending-fees"),{...l,[s]:t,...s==="class_id"?{section_id:""}:{}},{preserveState:!0,replace:!0})}n.useEffect(()=>{g(l?.search??"")},[l?.search]);function E(s){(l?.search??"")!==s&&x("search",s)}function C(s,t){const a=t===""?0:Number(t);h(i=>({...i,[s]:a}))}const c=n.useMemo(()=>d.filter(s=>!s.has_payments).filter(s=>(u[s.id]??0)!==(r[s.id]??0)).map(s=>({id:s.id,value:r[s.id]??0})),[d,r,u]);function F(){if(!c.length){alert("No changes to save.");return}if(c.find(t=>t.value===null||Number.isNaN(Number(t.value))||Number(t.value)<0)){p.error("Enter valid pending months for all edited rows.");return}j.patch(route("admin.utilities.pending-fees.bulk"),{updates:c},{preserveScroll:!0,onSuccess:()=>{f(t=>{const a={...t};return c.forEach(i=>{a[i.id]=i.value}),a}),p.success("Pending months updated.")},onError:t=>{const a=t?.assumed_pending_months||"Unable to update pending months.";p.error(a)}})}const N=!!o,y=n.useMemo(()=>d,[d]);return e.jsxs(P,{title:"Pending Fees Setup",children:[e.jsx("div",{className:"mb-4 rounded border border-yellow-300 bg-yellow-50 px-4 py-3 text-sm text-yellow-800",children:"This utility sets assumed pending months. Do NOT use after fee collection begins."}),e.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-end justify-between",children:[e.jsxs("div",{className:"flex flex-wrap gap-3 items-end",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1",children:"Class"}),e.jsxs("select",{className:"border px-3 py-2 rounded text-sm",value:o,onChange:s=>x("class_id",s.target.value),children:[e.jsx("option",{value:"",children:"Select class (required)"}),v.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1",children:"Section"}),e.jsxs("select",{className:"border px-3 py-2 rounded text-sm",value:w,disabled:!o,onChange:s=>x("section_id",s.target.value),children:[e.jsx("option",{value:"",children:"All Sections"}),S.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1",children:"Student Search"}),e.jsx("input",{className:"border px-3 py-2 rounded text-sm w-64",placeholder:"Name or student ID",value:_,onChange:s=>{const t=s.target.value;g(t),E(t)},disabled:!o})]})]}),e.jsx("button",{className:"px-4 py-2 rounded text-sm text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50",onClick:F,disabled:!N||c.length===0,children:"Save Changes"})]}),N?e.jsx("div",{className:"bg-white border rounded-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-[900px] text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left sticky left-0 z-10 bg-gray-50",children:"Student"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Father Name"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Class"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Section"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Monthly Fee"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Assumed Pending Months"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Pending Amount"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Status"})]})}),e.jsxs("tbody",{children:[y.map(s=>{const t=r[s.id]??0,a=Number(s.effective_monthly_fee||0),i=a*Number(t||0),m=s.has_payments,b=a===0;return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"px-3 py-2 sticky left-0 z-10 bg-white",children:s.student_name}),e.jsx("td",{className:"px-3 py-2",children:s.father_name||"-"}),e.jsx("td",{className:"px-3 py-2",children:s.class_name}),e.jsx("td",{className:"px-3 py-2",children:s.section_name||"-"}),e.jsxs("td",{className:"px-3 py-2",children:["Rs ",a]}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",min:"0",max:"255",className:"border px-2 py-1 rounded text-sm w-24",value:t,onChange:k=>C(s.id,k.target.value),disabled:m||b}),m&&e.jsx("span",{className:"text-xs text-gray-500",title:"Pending months are locked after fee collection.",children:"Locked"})]})}),e.jsxs("td",{className:"px-3 py-2",children:["Rs ",i]}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-500",children:b?"âœ… Free":m?"ðŸ”’ Locked":"Editable"})]},s.id)}),y.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-6 text-center text-gray-500",colSpan:8,children:"No students found for the selected filters."})})]})]})}):e.jsx("div",{className:"text-sm text-gray-600",children:"Select a class to view and edit pending fees."})]})}export{L as default};
