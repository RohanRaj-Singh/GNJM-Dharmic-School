import{r as o,j as t,a as g,z as n}from"./app-CF_lZ-2m.js";import{A as f}from"./AdminLayout-z4FWjLSy.js";import{u as R,f as v,b as M}from"./index-Ci1oky2Z.js";import{M as j}from"./MultiSelect-DAzHhJ4g.js";function P(){const[u,c]=o.useState([]),[m,b]=o.useState([]),[y,N]=o.useState(!0),[h,C]=o.useState(null),[a,i]=o.useState({name:"",username:"",role:"teacher",sections:[]});o.useEffect(()=>{Promise.all([fetch("/admin/users/data").then(e=>e.json()),fetch("/admin/sections/with-classes").then(e=>e.json())]).then(([e,s])=>{c(e),b(s),N(!1)})},[]);async function w(){if(!a.name||!a.username||!a.role){n.error("Name, username and role are required");return}if(a.role==="teacher"&&a.sections.length===0){n.error("Teacher must have at least one section");return}try{const e=await fetch("/admin/users",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify(a)});if(!e.ok)throw new Error("Request failed");const s=await e.json();s.success&&(n.success("User created successfully"),c(r=>[...r,s.user]),i({name:"",username:"",role:"teacher",sections:[]}))}catch{n.error("Failed to create user")}}function l(e,s,r){c(k=>k.map((p,A)=>A===e?{...p,[s]:r}:p))}function S(){const e=u.filter(s=>s.id);if(e.length===0){n.error("Nothing to save");return}for(const s of e){if(!s.name||!s.username||!s.role){n.error("Name, username and role are required");return}if(s.role==="teacher"&&(!s.sections||s.sections.length===0)){n.error(`Teacher "${s.name}" must have at least one section`);return}}g.post("/admin/users/save",{users:e},{onSuccess:()=>{n.success("Users updated successfully"),fetch("/admin/users/data").then(s=>s.json()).then(c)},onError:()=>{n.error("Failed to save users")}})}const d=o.useMemo(()=>m.flatMap(e=>e.sections.map(s=>({value:s.id,label:s.label}))),[m]),U=o.useMemo(()=>[{header:"#",cell:({row:e})=>e.index+1},{accessorKey:"name",header:"Name",cell:({row:e,column:s})=>t.jsx("input",{value:e.original.name,onChange:r=>l(e.index,s.id,r.target.value),className:"border px-2 py-1 rounded text-sm w-full"})},{accessorKey:"username",header:"Username",cell:({row:e,column:s})=>t.jsx("input",{value:e.original.username,onChange:r=>l(e.index,s.id,r.target.value),className:"border px-2 py-1 rounded text-sm w-full"})},{accessorKey:"role",header:"Role",cell:({row:e})=>t.jsxs("select",{value:e.original.role,onChange:s=>l(e.index,"role",s.target.value),className:"border px-2 py-1 rounded text-sm",children:[t.jsx("option",{value:"admin",children:"Admin"}),t.jsx("option",{value:"accountant",children:"Accountant"}),t.jsx("option",{value:"teacher",children:"Teacher"})]})},{accessorKey:"is_active",header:"Active",cell:({row:e})=>t.jsx("input",{type:"checkbox",checked:!!e.original.is_active,onChange:s=>l(e.index,"is_active",s.target.checked)})},{header:"Sections",cell:({row:e})=>e.original.role==="teacher"?t.jsx(j,{options:d,value:e.original.sections||[],onChange:s=>l(e.index,"sections",s),placeholder:"Select sections"}):t.jsx("span",{className:"text-gray-400 text-xs",children:"â€”"})},{header:"Password",cell:({row:e})=>{const s=e.original.id&&h===e.original.id;return t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("input",{type:s?"text":"password",value:e.original.password||"",onChange:r=>l(e.index,"password",r.target.value),className:"border px-2 py-1 rounded text-xs w-36",placeholder:"New password"}),e.original.id&&t.jsx("button",{type:"button",onClick:()=>C(s?null:e.original.id),className:"text-gray-500 hover:text-black text-sm",children:s?"ðŸ™ˆ":"ðŸ‘"})]})}},{header:"Actions",cell:({row:e})=>t.jsx("button",{onClick:()=>{confirm("Delete this user?")&&g.delete(`/admin/users/${e.original.id}`)},className:"text-red-600 text-sm",children:"Delete"})}],[d,h]),x=R({data:u,columns:U,getCoreRowModel:M()});return y?t.jsx(f,{title:"Users",children:"Loadingâ€¦"}):t.jsxs(f,{title:"Users",children:[t.jsxs("div",{className:"mb-4 flex flex-wrap gap-2 items-end",children:[t.jsx("input",{placeholder:"Name",value:a.name,onChange:e=>i({...a,name:e.target.value}),className:"border px-2 py-1 rounded"}),t.jsx("input",{placeholder:"Username",value:a.username,onChange:e=>i({...a,username:e.target.value}),className:"border px-2 py-1 rounded"}),t.jsxs("select",{value:a.role,onChange:e=>i({...a,role:e.target.value}),className:"border px-2 py-1 rounded",children:[t.jsx("option",{value:"admin",children:"Admin"}),t.jsx("option",{value:"accountant",children:"Accountant"}),t.jsx("option",{value:"teacher",children:"Teacher"})]}),a.role==="teacher"&&t.jsx(j,{options:d,value:a.sections,onChange:e=>i({...a,sections:e}),placeholder:"Select sections"}),t.jsx("button",{onClick:w,className:"bg-blue-600 text-white px-3 py-1 rounded",children:"Add User"})]}),t.jsx("button",{onClick:S,className:"mb-3 bg-green-600 text-white px-4 py-2 rounded",children:"Save User Updates"}),t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full bg-white border text-sm",children:[t.jsx("thead",{children:x.getHeaderGroups().map(e=>t.jsx("tr",{children:e.headers.map(s=>t.jsx("th",{className:"px-3 py-2 border-b text-left",children:v(s.column.columnDef.header,s.getContext())},s.id))},e.id))}),t.jsx("tbody",{children:x.getRowModel().rows.map(e=>t.jsx("tr",{children:e.getVisibleCells().map(s=>t.jsx("td",{className:"px-3 py-2 border-b align-top min-w-[150px]",children:v(s.column.columnDef.cell,s.getContext())},s.id))},e.id))})]})})]})}export{P as default};
