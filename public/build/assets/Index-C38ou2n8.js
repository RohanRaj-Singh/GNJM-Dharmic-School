import{j as s,r as a,a as D,z as h}from"./app-DJfHBbO4.js";import{A as G}from"./AdminLayout-Z3678DNH.js";import U from"./EnrollmentsCell-u1HkN2KM.js";import{u as H,f as F,g as Y,a as J,b as O}from"./index-BtBcHxdd.js";function Q({text:o="Loading..."}){return s.jsx("div",{className:"relative min-h-[300px] bg-white border rounded-lg",children:s.jsx("div",{className:"absolute inset-0 z-30 bg-white/80 flex items-center justify-center",children:s.jsxs("div",{className:"flex flex-col items-center gap-3",children:[s.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-gray-300 border-t-blue-600"}),s.jsx("p",{className:"text-sm text-gray-600",children:o})]})})})}function te(){const[o,d]=a.useState([]),[b,M]=a.useState([]),[x,A]=a.useState({}),[L,$]=a.useState([]),[v,j]=a.useState(""),[k,I]=a.useState({}),[g,y]=a.useState(!0),[m,w]=a.useState(!1),[l,c]=a.useState(!1),[i,S]=a.useState(!1),f=a.useRef(!1),N=a.useRef(null);a.useEffect(()=>{C()},[]);function C(){y(!0),w(!1),Promise.all([fetch("/admin/students/data").then(e=>e.json()),fetch("/admin/classes/options").then(e=>e.json())]).then(([e,t])=>{d(e),M(t)}).finally(()=>y(!1))}a.useEffect(()=>{if(!g){const e=setTimeout(()=>w(!0),400);return()=>clearTimeout(e)}},[g]);function p(e,t,n){d(r=>r.map((u,q)=>q===e?{...u,[t]:n}:u)),c(!0)}function K(e){if(!e)return;const t=String(e);x[t]||fetch(`/admin/sections/options?class_id=${e}`).then(n=>n.json()).then(n=>{A(r=>({...r,[t]:n}))})}a.useEffect(()=>{const e=t=>{!l||i||(t.preventDefault(),t.returnValue="")};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[l,i]),a.useEffect(()=>{const e=D.on("before",t=>{!l||f.current||confirm("You have unsaved changes. Leave anyway?")||t.preventDefault()});return()=>e()},[l,i]);function R({row:e,column:t,autoFocus:n=!1}){return s.jsx("input",{ref:n?N:null,defaultValue:e.original[t.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:r=>p(e.index,t.id,r.target.value),onKeyDown:r=>{r.key==="Enter"&&r.currentTarget.blur()}})}function _({row:e,column:t}){return s.jsx("input",{defaultValue:e.original[t.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:n=>{const r=n.target.value.trim();if(r&&!/^\d{10,15}$/.test(r)){h.error("Phone must be 10–15 digits");return}p(e.index,t.id,r)}})}function P({row:e,column:t}){return s.jsxs("select",{value:e.original[t.id]??"active",onChange:n=>p(e.index,t.id,n.target.value),className:"w-full px-2 py-1 border rounded text-sm",children:[s.jsx("option",{value:"active",children:"Active"}),s.jsx("option",{value:"inactive",children:"Inactive"})]})}const T=a.useMemo(()=>[{header:"#",cell:({row:e})=>e.index+1},{accessorKey:"id",header:"Student ID",cell:({row:e})=>e.original.id??"—"},{accessorKey:"name",header:"Name",cell:({row:e,column:t})=>s.jsx(R,{row:e,column:t,autoFocus:e.original.__isNew})},{accessorKey:"father_name",header:"Father Name",cell:({row:e,column:t})=>s.jsx(R,{row:e,column:t})},{accessorKey:"father_phone",header:"Father Phone",cell:({row:e,column:t})=>s.jsx(_,{row:e,column:t})},{accessorKey:"mother_phone",header:"Mother Phone",cell:({row:e,column:t})=>s.jsx(_,{row:e,column:t})},{accessorKey:"status",header:"Status",cell:({row:e,column:t})=>s.jsx(P,{row:e,column:t})},{header:"Enrollments",cell:({row:e})=>s.jsx(U,{row:e,classes:b,sectionsByClass:x,loadSections:K,setData:d,setIsDirty:c})},{header:"Actions",cell:({row:e})=>s.jsx("button",{className:"text-red-600 text-sm",onClick:()=>{confirm("Delete this student? All enrollments will be removed.")&&(d(t=>t.filter((n,r)=>r!==e.index)),c(!0))},children:"Delete"})}],[b,x]),E=H({data:o,columns:T,getRowId:e=>e.id?`student-${e.id}`:e.__tempId,state:{sorting:L,globalFilter:v,rowSelection:k},onSortingChange:$,onGlobalFilterChange:j,onRowSelectionChange:I,getCoreRowModel:O(),getFilteredRowModel:J(),getSortedRowModel:Y(),globalFilterFn:"includesString"});function z(e){if(!e.name?.trim())return"Student name is required";if(!e.enrollments?.length)return"At least one enrollment required";const t=new Set;for(const n of e.enrollments){if(!n.class_id||!n.section_id)return"Each enrollment needs class & section";const r=`${n.class_id}-${n.section_id}`;if(t.has(r))return"Duplicate class + section enrollment";t.add(r)}return null}function B(){if(!l||f.current)return;const e=[],t=[];if(o.forEach((n,r)=>{const u=z(n);u?e.push(`Row ${r+1}: ${u}`):t.push(n)}),e.length){h.error(s.jsxs("div",{children:[s.jsx("strong",{children:"Fix these issues:"}),s.jsx("ul",{className:"list-disc ml-4 mt-1",children:e.slice(0,5).map((n,r)=>s.jsx("li",{children:n},r))})]}),{duration:6e3});return}S(!0),f.current=!0,D.post("/admin/students/bulk-update",{students:t},{preserveScroll:!0,onSuccess:()=>{h.success("Changes saved"),c(!1),C()},onFinish:()=>{S(!1),f.current=!1}})}function V(){if(!m)return;if(o.some(t=>t.__isNew&&!t.name?.trim())){h.error("Finish the current new student first");return}d(t=>[{id:null,__tempId:crypto.randomUUID(),name:"",father_name:"",father_phone:"",mother_phone:"",status:"active",enrollments:[],__isNew:!0},...t]),c(!0),requestAnimationFrame(()=>{N.current?.focus()})}return s.jsxs(G,{title:"Students",children:[s.jsxs("div",{className:"flex flex-col gap-3 mb-4 sm:flex-row sm:justify-between",children:[s.jsx("input",{className:"w-full sm:w-64 px-3 py-2 border rounded-lg text-sm",placeholder:"Search students…",value:v,onChange:e=>j(e.target.value)}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:V,disabled:!m,className:"px-4 py-2 bg-blue-600 text-white rounded-lg text-sm disabled:opacity-50",children:"+ Add Student"}),s.jsx("button",{onClick:B,disabled:!l||i,className:`
    px-4 py-2 rounded-lg text-sm whitespace-nowrap
    ${i?"bg-green-400 cursor-not-allowed":"bg-green-600 hover:bg-green-700"}
    text-white disabled:opacity-60
  `,children:i?"Saving…":"Save Changes"})]})]}),g?s.jsx(Q,{text:"Loading students…"}):s.jsxs("div",{className:"relative",children:[!m&&s.jsx("div",{className:"absolute inset-0 z-30 bg-white/60 flex items-center justify-center",children:s.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[s.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-gray-300 border-t-blue-600"}),"Preparing editor…"]})}),s.jsx("div",{className:m?"":"pointer-events-none",children:s.jsx("div",{className:"bg-white border rounded-lg overflow-x-auto",children:s.jsxs("table",{className:"min-w-[900px] text-sm",children:[s.jsx("thead",{className:"bg-gray-50 border-b",children:E.getHeaderGroups().map(e=>s.jsx("tr",{children:e.headers.map(t=>s.jsx("th",{className:"px-3 py-2 text-left",children:F(t.column.columnDef.header,t.getContext())},t.id))},e.id))}),s.jsx("tbody",{children:E.getRowModel().rows.map(e=>s.jsx("tr",{className:"border-b",children:e.getVisibleCells().map(t=>s.jsx("td",{className:"px-3 py-2",children:F(t.column.columnDef.cell,t.getContext())},t.id))},e.id))})]})})})]})]})}export{te as default};
