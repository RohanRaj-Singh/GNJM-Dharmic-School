import{j as n,r as a,z as o,a as A}from"./app-CRto17y-.js";import{A as se}from"./AdminLayout-ZsL_PlfI.js";import ne from"./EnrollmentsCell-BuFi-YdS.js";import re from"./useStudentFilters-DKluVl7V.js";import{u as le,f as P,g as ae,a as ie,b as oe}from"./index-BQ8yVVub.js";function de({text:d="Loading..."}){return n.jsx("div",{className:"relative min-h-[300px] bg-white border rounded-lg",children:n.jsx("div",{className:"absolute inset-0 z-30 bg-white/80 flex items-center justify-center",children:n.jsxs("div",{className:"flex flex-col items-center gap-3",children:[n.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-gray-300 border-t-blue-600"}),n.jsx("p",{className:"text-sm text-gray-600",children:d})]})})})}function pe(){const[d,c]=a.useState([]),[_,U]=a.useState([]),[m,B]=a.useState({}),[L,z]=a.useState([]),[F,N]=a.useState(""),[x,w]=a.useState(!0),[D,R]=a.useState(!1),[I,u]=a.useState(!1),[g,k]=a.useState(!1),[b,M]=a.useState(null),S=a.useRef(!1),$=a.useRef(null),E=()=>globalThis.crypto?.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,{classFilter:i,sectionFilter:f,feeFilter:h,setClassFilter:K,setSectionFilter:G,setFeeFilter:V,columnFilters:q,filterFns:H,resetFilters:O}=re();a.useEffect(()=>{j()},[]);function j(){return w(!0),R(!1),Promise.all([fetch("/admin/students/data").then(e=>e.json()),fetch("/admin/classes/options").then(e=>e.json())]).then(([e,t])=>{const s=e.map(l=>({...l,enrollments:(l.enrollments||[]).map(r=>({id:r.id??E(),class_id:String(r.class_id??""),section_id:String(r.section_id??""),student_type:r.student_type??"paid"}))}));return c(s),U(t),s}).catch(()=>o.error("Failed to load students")).finally(()=>w(!1))}a.useEffect(()=>{if(!x){const e=setTimeout(()=>R(!0),300);return()=>clearTimeout(e)}},[x]),a.useEffect(()=>{if(!b)return;const e=setTimeout(()=>{$.current?.focus(),M(null)},0);return()=>clearTimeout(e)},[b,d.length]);const p=a.useCallback((e,t,s)=>{c(l=>l.map((r,C)=>C===e?{...r,[t]:s}:r)),u(!0)},[]);function J(e){if(!e)return;const t=String(e);m[t]||fetch(`/admin/sections/options?class_id=${e}`).then(s=>s.json()).then(s=>B(l=>({...l,[t]:s})))}const Q=a.useMemo(()=>{if(i==="all")return[];const e=m[String(i)];return Array.isArray(e)?e.map(t=>({id:String(t.id),name:t.name})):[]},[i,m]),y=a.useMemo(()=>function({row:t,column:s,autoFocus:l=!1}){return n.jsx("input",{ref:l?$:null,defaultValue:t.original[s.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:r=>p(t.index,s.id,r.target.value)})},[p]),v=a.useMemo(()=>function({row:t,column:s}){return n.jsx("input",{defaultValue:t.original[s.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:l=>{const r=l.target.value.trim();if(r&&!/^\d{10,15}$/.test(r)){o.error("Phone must be 10-15 digits");return}p(t.index,s.id,r)}})},[p]),W=a.useMemo(()=>[{header:"#",cell:({row:e})=>e.index+1},{accessorKey:"name",header:"Name",enableSorting:!0,cell:({row:e,column:t,table:s})=>n.jsx(y,{row:e,column:t,autoFocus:e.original.__isNew&&e.original.__tempId===s.options.meta.pendingFocusId})},{accessorKey:"father_name",header:"Father",cell:({row:e,column:t})=>n.jsx(y,{row:e,column:t})},{accessorKey:"father_phone",header:"Father Phone",cell:({row:e,column:t})=>n.jsx(v,{row:e,column:t})},{accessorKey:"mother_phone",header:"Mother Phone",cell:({row:e,column:t})=>n.jsx(v,{row:e,column:t})},{header:"Enrollments",cell:({row:e,table:t})=>{const{classes:s,sectionsByClass:l,loadSections:r,setData:C,setIsDirty:te}=t.options.meta;return n.jsx(ne,{row:e,classes:s,sectionsByClass:l,loadSections:r,setData:C,setIsDirty:te})}},{header:"Actions",cell:({row:e})=>n.jsx("button",{className:"text-red-600 text-sm",onClick:()=>{if(confirm("Delete this student? All enrollments will be removed.")){const t=e.original.id;if(!t){c(s=>s.filter((l,r)=>r!==e.index)),u(!0);return}A.delete(`/admin/students/${t}`,{preserveScroll:!0,onSuccess:()=>{j().then(s=>{if(s?.some(r=>String(r.id)===String(t))){o.error("Delete failed. Student still exists.");return}o.success("Student deleted")})},onError:()=>o.error("Failed to delete student")})}},children:"Delete"})}],[v,y]),X=a.useMemo(()=>d.filter(e=>!(i!=="all"&&!e.enrollments?.some(s=>String(s.class_id)===String(i))||f!=="all"&&!e.enrollments?.some(s=>String(s.section_id)===String(f))||h!=="all"&&!e.enrollments?.some(s=>h==="free"?s.student_type==="free":s.student_type!=="free"))),[d,i,f,h]),T=le({data:X,columns:W,getRowId:e=>e.id?`student-${e.id}`:e.__tempId,meta:{classes:_,sectionsByClass:m,loadSections:J,setData:c,setIsDirty:u,pendingFocusId:b},state:{sorting:L,globalFilter:F,columnFilters:q},filterFns:H,onSortingChange:z,onGlobalFilterChange:N,getCoreRowModel:oe(),getFilteredRowModel:ie(),getSortedRowModel:ae(),globalFilterFn:"includesString"});function Y(){if(!D)return;if(d.some(s=>s.__isNew&&!s.name?.trim())){o.error("Finish the current new student first");return}const t=E();c(s=>[{id:null,__tempId:t,name:"",father_name:"",father_phone:"",mother_phone:"",status:"active",enrollments:[],__isNew:!0},...s]),u(!0),M(t)}function Z(e){if(!e.name?.trim())return"Student name is required";if(!e.enrollments?.length)return"At least one enrollment required";const t=new Set;for(const s of e.enrollments){if(!s.class_id||!s.section_id)return"Each enrollment needs class & section";const l=`${s.class_id}-${s.section_id}`;if(t.has(l))return"Duplicate class + section enrollment";t.add(l)}return null}function ee(){if(!I||S.current)return;const e=[],t=[];if(d.forEach((s,l)=>{const r=Z(s);r?e.push(`Row ${l+1}: ${r}`):t.push(s)}),e.length){o.error(n.jsxs("div",{children:[n.jsx("strong",{children:"Fix these issues:"}),n.jsx("ul",{className:"list-disc ml-4 mt-1",children:e.slice(0,5).map((s,l)=>n.jsx("li",{children:s},l))})]}),{duration:6e3});return}k(!0),S.current=!0,A.post("/admin/students/bulk-update",{students:t},{preserveScroll:!0,onSuccess:()=>{o.success("Changes saved"),u(!1),j()},onFinish:()=>{k(!1),S.current=!1}})}return n.jsxs(se,{title:"Students",children:[n.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-center justify-between",children:[n.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[n.jsx("input",{className:"px-3 py-2 border rounded text-sm w-64",placeholder:"Search...",value:F,onChange:e=>N(e.target.value)}),n.jsxs("select",{value:i,onChange:e=>K(e.target.value),className:"px-3 py-2 border rounded text-sm",children:[n.jsx("option",{value:"all",children:"All Classes"}),_.map(e=>n.jsx("option",{value:String(e.id),children:e.name},e.id))]}),n.jsxs("select",{value:f,onChange:e=>G(e.target.value),disabled:i==="all",className:"px-3 py-2 border rounded text-sm disabled:bg-gray-100",children:[n.jsx("option",{value:"all",children:i==="all"?"Select class first":"All Sections"}),Q.map(e=>n.jsx("option",{value:e.id,children:e.name},e.id))]}),n.jsxs("select",{value:h,onChange:e=>V(e.target.value),className:"px-3 py-2 border rounded text-sm",children:[n.jsx("option",{value:"all",children:"Paid & Free"}),n.jsx("option",{value:"paid",children:"Paid"}),n.jsx("option",{value:"free",children:"Free"})]}),n.jsx("button",{onClick:O,className:"px-3 py-2 border rounded text-sm",children:"Reset"})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("button",{onClick:Y,disabled:!D,className:"px-4 py-2 bg-blue-600 text-white rounded text-sm disabled:opacity-50",children:"+ Add Student"}),n.jsx("button",{onClick:ee,disabled:!I||g,className:`px-4 py-2 rounded text-sm text-white ${g?"bg-green-400":"bg-green-600 hover:bg-green-700"} disabled:opacity-50`,children:g?"Saving...":"Save Changes"})]})]}),x?n.jsx(de,{text:"Loading students..."}):n.jsx("div",{className:"bg-white border rounded overflow-x-auto",children:n.jsxs("table",{className:"min-w-[900px] text-sm",children:[n.jsx("thead",{className:"bg-gray-50",children:T.getHeaderGroups().map(e=>n.jsx("tr",{children:e.headers.map(t=>n.jsxs("th",{className:"px-3 py-2 cursor-pointer select-none",onClick:t.column.getToggleSortingHandler(),children:[P(t.column.columnDef.header,t.getContext()),{asc:" â–²",desc:" â–¼"}[t.column.getIsSorted()]??""]},t.id))},e.id))}),n.jsx("tbody",{children:T.getRowModel().rows.map(e=>n.jsx("tr",{className:"border-b",children:e.getVisibleCells().map(t=>n.jsx("td",{className:`px-3 py-2 min-${t.column.columnDef.header==="#"?"w-auto":"w-[150px]"} border-b align-top`,children:P(t.column.columnDef.cell,t.getContext())},t.id))},e.id))})]})})]})}export{pe as default};
