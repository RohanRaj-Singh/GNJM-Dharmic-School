import{r as o,j as e}from"./app-4YogvTzo.js";import{A as D}from"./AdminLayout-DIb80SUw.js";import{f as g}from"./helper-BxvJq_M8.js";import"./logo-CAn8f4K1.js";function t(d){const r=Number(d);return Number.isFinite(r)?r:0}function y(d){const r=String(d?.name??"").trim();return r.length?r:`Class #${t(d?.id)}`}function m({label:d,value:r,sub:b,accent:u="bg-slate-700"}){return e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:d}),e.jsx("span",{className:`h-2.5 w-2.5 rounded-full ${u}`})]}),e.jsx("p",{className:"text-xl font-semibold text-slate-800",children:r}),b?e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:b}):null]})}function M({label:d,value:r,total:b,tone:u="bg-blue-600",suffix:j=""}){const a=t(r),v=t(b),f=v>0?Math.max(0,Math.min(100,Math.round(a/v*100))):0;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1",children:[e.jsx("span",{className:"text-slate-600",children:d}),e.jsxs("span",{className:"font-medium text-slate-800",children:[r,j]})]}),e.jsx("div",{className:"h-2 rounded-full bg-slate-100 overflow-hidden",children:e.jsx("div",{className:`h-full ${u}`,style:{width:`${f}%`}})})]})}function L(){const d=new Date().getFullYear(),[r,b]=o.useState(String(d)),[u,j]=o.useState(!0),[a,v]=o.useState(null),[f,_]=o.useState(""),[h,w]=o.useState("gurmukhi"),[i,N]=o.useState("all"),[c,p]=o.useState("all");o.useEffect(()=>{j(!0),_(""),fetch(`/admin/dashboard/summary?year=${r}`).then(async s=>{if(!s.ok)throw new Error("Failed to load dashboard summary");return s.json()}).then(s=>{v(s),(s?.divisions??[]).some(n=>n.type===h)||w(s?.divisions?.[0]?.type??"gurmukhi")}).catch(s=>{_(s.message||"Unable to load dashboard data")}).finally(()=>j(!1))},[r]);const l=o.useMemo(()=>(a?.divisions??[]).find(s=>s.type===h)??null,[a,h]),x=o.useMemo(()=>!l||i==="all"?null:l.classes.find(s=>String(s.id)===String(i))??null,[l,i]),C=x?x.sections:[],$=c==="all"?C:C.filter(s=>String(s.id)===String(c));o.useEffect(()=>{if(!l){N("all"),p("all");return}i!=="all"&&!l.classes.some(s=>String(s.id)===String(i))&&(N("all"),p("all"))},[l,i]),o.useEffect(()=>{if(!x){p("all");return}c!=="all"&&!x.sections.some(s=>String(s.id)===String(c))&&p("all")},[x,c]);const F=o.useMemo(()=>(a?.insights?.top_absentees??[]).filter(n=>n.division_type===h).filter(n=>i==="all"||String(n.class_id)===String(i)).filter(n=>c==="all"||String(n.section_id)===String(c)).sort((n,S)=>t(S.absent_days)-t(n.absent_days)),[a,h,i,c]),A=o.useMemo(()=>(a?.insights?.top_pending_fees??[]).filter(n=>n.division_type===h).filter(n=>i==="all"||String(n.class_id)===String(i)).filter(n=>c==="all"||String(n.section_id)===String(c)).sort((n,S)=>t(S.pending_amount)-t(n.pending_amount)),[a,h,i,c]);return e.jsx(D,{title:"Dashboard",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-white border rounded-xl px-4 py-3",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-semibold text-slate-800",children:"School Admin Dashboard"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Fees, attendance and division performance in one operational view."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs uppercase text-slate-500",children:"Year"}),e.jsx("select",{value:r,onChange:s=>b(s.target.value),className:"border rounded-md px-2 py-1.5 text-sm",children:[d-2,d-1,d,d+1].map(s=>e.jsx("option",{value:String(s),children:s},s))})]})]})}),u?e.jsx("div",{className:"bg-white border rounded-xl p-6 text-sm text-slate-500",children:"Loading dashboard..."}):null,!u&&f?e.jsx("div",{className:"bg-white border rounded-xl p-6 text-sm text-rose-600",children:f}):null,!u&&!f&&a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-3",children:[e.jsx(m,{label:"Total Fees",value:g(t(a.fees.total)),accent:"bg-blue-600"}),e.jsx(m,{label:"Collected",value:g(t(a.fees.collected)),accent:"bg-emerald-600"}),e.jsx(m,{label:"Pending",value:g(t(a.fees.pending)),accent:"bg-rose-600"}),e.jsx(m,{label:"Collection Rate",value:`${t(a.fees.percentage)}%`,sub:"Collected / Total",accent:"bg-violet-600"}),e.jsx(m,{label:"Active Students",value:t(a.students.active),sub:`${t(a.students.total)} total students`,accent:"bg-amber-500"})]}),e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 mb-4",children:[e.jsx("div",{className:"inline-flex border rounded-lg p-1 bg-slate-50",children:(a.divisions??[]).map(s=>e.jsx("button",{onClick:()=>{w(s.type),N("all"),p("all")},className:`px-3 py-1.5 rounded-md text-sm border ${h===s.type?"bg-emerald-600 border-emerald-600 text-white":"bg-white border-slate-200 text-slate-700 hover:bg-slate-100"}`,children:s.title},s.type))}),l?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:i,onChange:s=>{N(s.target.value),p("all")},className:"border rounded-md px-2 py-1.5 text-sm min-w-[220px] bg-white text-slate-800",children:[e.jsxs("option",{value:"all",children:["All Classes (",l.title,")"]}),l.classes.map(s=>e.jsx("option",{value:String(s.id),children:y(s)},s.id))]}),e.jsxs("select",{value:c,onChange:s=>p(s.target.value),disabled:!x,className:"border rounded-md px-2 py-1.5 text-sm min-w-[220px] bg-white text-slate-800 disabled:bg-slate-100",children:[e.jsx("option",{value:"all",children:x?`All Sections (${y(x)})`:"Select class first"}),(x?.sections??[]).map(s=>e.jsx("option",{value:String(s.id),children:s.name},s.id))]})]}):null]}),l?e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"xl:col-span-1 border rounded-lg p-3 bg-slate-50/60",children:[e.jsxs("p",{className:"text-xs uppercase text-slate-500 mb-3",children:[l.title," Overview"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(M,{label:"Division Fee Collection",value:t(l.fees.collected),total:Math.max(1,t(l.fees.total)),tone:"bg-emerald-600",suffix:""}),e.jsx(M,{label:"Division Attendance (Present %)",value:t(l.attendance.percentage),total:100,tone:"bg-blue-600",suffix:"%"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 pt-1",children:[e.jsx(m,{label:"Classes",value:t(l.stats.classes_count),accent:"bg-slate-600"}),e.jsx(m,{label:"Sections",value:t(l.stats.sections_count),accent:"bg-slate-600"}),e.jsx(m,{label:"Students",value:t(l.stats.students_count),accent:"bg-amber-500"}),e.jsx(m,{label:"Active",value:t(l.stats.active_students_count),accent:"bg-emerald-600"})]})]})]}),e.jsxs("div",{className:"xl:col-span-2 space-y-4",children:[e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-3 py-2 bg-slate-50 border-b text-sm font-medium text-slate-700",children:"Class Performance"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-white border-b text-slate-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-3 py-2",children:"Class"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Students"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Fees"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Collection %"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Attendance %"})]})}),e.jsx("tbody",{children:l.classes.filter(s=>i==="all"||String(s.id)===String(i)).map(s=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"px-3 py-2 font-medium text-slate-800",children:y(s)}),e.jsx("td",{className:"px-3 py-2",children:t(s.students_count)}),e.jsx("td",{className:"px-3 py-2",children:g(t(s.fees.total))}),e.jsxs("td",{className:"px-3 py-2",children:[t(s.fees.percentage),"%"]}),e.jsxs("td",{className:"px-3 py-2",children:[t(s.attendance.percentage),"%"]})]},s.id))})]})})]}),i!=="all"?e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"px-3 py-2 bg-slate-50 border-b text-sm font-medium text-slate-700",children:["Section Summary"," ",x?`- ${y(x)}`:"",c!=="all"?` / ${x?.sections.find(s=>String(s.id)===String(c))?.name??"Selected Section"}`:""]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-white border-b text-slate-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-3 py-2",children:"Section"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Students"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Fees"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Collection %"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Attendance %"})]})}),e.jsxs("tbody",{children:[$.map(s=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"px-3 py-2 font-medium text-slate-800",children:s.name}),e.jsx("td",{className:"px-3 py-2",children:t(s.students_count)}),e.jsx("td",{className:"px-3 py-2",children:g(t(s.fees.total))}),e.jsxs("td",{className:"px-3 py-2",children:[t(s.fees.percentage),"%"]}),e.jsxs("td",{className:"px-3 py-2",children:[t(s.attendance.percentage),"%"]})]},s.id)),$.length===0?e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-slate-400",colSpan:5,children:"No sections found for this class."})}):null]})]})})]}):e.jsx("div",{className:"border rounded-lg p-3 bg-slate-50 text-sm text-slate-500",children:"Select a class to view section-level summaries."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-3 py-2 bg-slate-50 border-b text-sm font-medium text-slate-700",children:"Most Absent Students"}),e.jsx("div",{className:"max-h-72 overflow-y-auto",children:F.length===0?e.jsx("p",{className:"px-3 py-4 text-sm text-slate-400",children:"No absent-student data for this filter."}):F.slice(0,20).map(s=>e.jsxs("div",{className:"px-3 py-2 border-b text-sm",children:[e.jsx("div",{className:"font-medium text-slate-800",children:s.student_name}),e.jsxs("div",{className:"text-xs text-slate-500",children:[s.class_name,s.section_name?` / ${s.section_name}`:""," ",s.father_name?`• Father: ${s.father_name}`:""]}),e.jsxs("div",{className:"text-xs text-rose-700 font-semibold mt-1",children:[t(s.absent_days)," absent day(s)"]})]},`${s.enrollment_id}-abs`))})]}),e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-3 py-2 bg-slate-50 border-b text-sm font-medium text-slate-700",children:"Highest Pending Fees"}),e.jsx("div",{className:"max-h-72 overflow-y-auto",children:A.length===0?e.jsx("p",{className:"px-3 py-4 text-sm text-slate-400",children:"No pending-fee data for this filter."}):A.slice(0,20).map(s=>e.jsxs("div",{className:"px-3 py-2 border-b text-sm",children:[e.jsx("div",{className:"font-medium text-slate-800",children:s.student_name}),e.jsxs("div",{className:"text-xs text-slate-500",children:[s.class_name,s.section_name?` / ${s.section_name}`:""," ",s.father_name?`• Father: ${s.father_name}`:""]}),e.jsxs("div",{className:"text-xs text-amber-700 font-semibold mt-1",children:[g(t(s.pending_amount))," pending (",t(s.pending_fee_count)," fee item(s))"]})]},`${s.enrollment_id}-fee`))})]})]})]})]}):e.jsx("div",{className:"text-sm text-slate-500",children:"No division data found."})]}),e.jsxs("div",{className:"text-xs text-right text-slate-400",children:["Last updated: ",a.meta.generated_at]})]}):null]})})}export{L as default};
