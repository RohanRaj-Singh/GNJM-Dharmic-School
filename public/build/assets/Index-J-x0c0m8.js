import{r as i,j as s,z as n,a as M}from"./app-CKCcpFSt.js";import{A}from"./AdminLayout-DVIreQcb.js";import{u as k,f as j,g as T,a as D,b as $}from"./index-Cm7UzJJ4.js";function U(){const[c,m]=i.useState([]),[b,y]=i.useState([]),[f,x]=i.useState(""),[a,r]=i.useState({open:!1,classId:null,className:"",periods:[],editingId:null,amount:0,effective_from:"",effective_to:""}),p=i.useRef(null);function h(){fetch("/admin/classes/data").then(e=>e.json()).then(m)}i.useEffect(h,[]);function N(e,t,l){m(o=>o.map((d,R)=>R===e?{...d,[t]:l}:d))}function v({row:e,column:t,autoFocus:l=!1}){const o=l?p:null;return s.jsx("input",{ref:o,defaultValue:e.original[t.id]??"",className:"w-full px-2 py-1 border rounded text-sm",onBlur:d=>N(e.index,t.id,d.target.value)})}async function u(e){if(!e.original.id){n.error("Save class first, then configure fee timeline");return}try{const l=(await window.axios.get(`/admin/classes/${e.original.id}/fee-periods`,{headers:{Accept:"application/json"}}))?.data??{};r({open:!0,classId:e.original.id,className:e.original.name,periods:l.periods??[],editingId:null,amount:0,effective_from:"",effective_to:""})}catch{n.error("Failed to load fee timeline")}}async function w(){if(!a.effective_from){n.error("Start month is required");return}const e=a.editingId?`/admin/classes/${a.classId}/fee-periods/${a.editingId}`:`/admin/classes/${a.classId}/fee-periods`,t=a.editingId?"PUT":"POST";try{await window.axios.request({url:e,method:t.toLowerCase(),headers:{Accept:"application/json"},data:{amount:Number(a.amount||0),effective_from:a.effective_from,effective_to:a.effective_to||null}}),await u({original:{id:a.classId,name:a.className}}),n.success("Fee period saved")}catch(l){const o=l?.response?.data,d=o?.message||Object.values(o?.errors??{}).flat()?.[0]||l?.message;n.error(d||"Could not save period")}}async function _(e){if(confirm("Delete this fee period?"))try{await window.axios.delete(`/admin/classes/${a.classId}/fee-periods/${e}`,{headers:{Accept:"application/json"}}),await u({original:{id:a.classId,name:a.className}}),n.success("Fee period deleted")}catch(t){const l=t?.response?.data,o=l?.message||Object.values(l?.errors??{}).flat()?.[0]||t?.message;n.error(o||"Could not delete period")}}function C(e){r(t=>({...t,editingId:e.id,amount:e.amount,effective_from:e.effective_from,effective_to:e.effective_to??""}))}const F=i.useMemo(()=>[{accessorKey:"name",header:"Class Name",cell:({row:e,column:t})=>s.jsx(v,{row:e,column:t,autoFocus:e.original.__isNew})},{accessorKey:"default_monthly_fee",header:"Legacy Monthly Fee",cell:({row:e})=>s.jsxs("span",{className:"text-gray-500",children:["Rs. ",e.original.default_monthly_fee??0]})},{accessorKey:"sections_count",header:"Sections",cell:({row:e})=>s.jsx("span",{className:"text-gray-600",children:e.original.sections_count??0})},{header:"Fee Timeline",cell:({row:e})=>s.jsx("button",{onClick:()=>u(e),className:"px-2 py-1 text-xs bg-slate-700 text-white rounded",children:"Manage"})}],[]),g=k({data:c,columns:F,getRowId:e=>e.id?`class-${e.id}`:e.__tempId,state:{sorting:b,globalFilter:f},onSortingChange:y,onGlobalFilterChange:x,getCoreRowModel:$(),getFilteredRowModel:D(),getSortedRowModel:T(),globalFilterFn:"includesString"});function I(){const e={id:null,__tempId:crypto.randomUUID(),name:"",default_monthly_fee:0,sections_count:0,__isNew:!0};m(t=>[e,...t]),requestAnimationFrame(()=>{p.current?.focus()})}function S(){if(c.some(e=>!e.name?.trim())){n.error("Class name cannot be empty");return}M.post("/admin/classes/save",{classes:c},{onSuccess:()=>{n.success("Classes saved"),h()},onError:()=>n.error("Save failed")})}return s.jsxs(A,{title:"Classes",children:[s.jsxs("div",{className:"flex flex-wrap justify-between gap-3 mb-4",children:[s.jsx("input",{className:"px-3 py-2 border rounded text-sm w-64",placeholder:"Search classes...",value:f,onChange:e=>x(e.target.value)}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:I,className:"px-4 py-2 bg-blue-600 text-white rounded",children:"+ Add Class"}),s.jsx("button",{onClick:S,className:"px-4 py-2 bg-green-600 text-white rounded",children:"Save Changes"})]})]}),s.jsx("div",{className:"bg-white border rounded overflow-auto",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"bg-gray-50 border-b",children:g.getHeaderGroups().map(e=>s.jsx("tr",{children:e.headers.map(t=>s.jsxs("th",{className:"px-3 py-2 text-left font-medium cursor-pointer",onClick:t.column.getToggleSortingHandler(),children:[j(t.column.columnDef.header,t.getContext()),{asc:" ↑",desc:" ↓"}[t.column.getIsSorted()]??""]},t.id))},e.id))}),s.jsx("tbody",{children:g.getRowModel().rows.map(e=>s.jsx("tr",{className:"border-b hover:bg-gray-50",children:e.getVisibleCells().map(t=>s.jsx("td",{className:"px-3 py-2",children:j(t.column.columnDef.cell,t.getContext())},t.id))},e.id))})]})}),a.open&&s.jsx("div",{className:"fixed inset-0 z-40 bg-black/40 flex items-center justify-center p-4",children:s.jsxs("div",{className:"bg-white rounded shadow-xl w-full max-w-2xl p-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-3",children:[s.jsxs("h3",{className:"font-semibold",children:["Class Fee Timeline: ",a.className]}),s.jsx("button",{onClick:()=>r(e=>({...e,open:!1})),className:"text-sm text-gray-500",children:"Close"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-2 mb-3",children:[s.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 text-sm",placeholder:"Amount",value:a.amount,onChange:e=>r(t=>({...t,amount:Number(e.target.value||0)}))}),s.jsx("input",{type:"month",className:"border rounded px-2 py-1 text-sm",value:a.effective_from,onChange:e=>r(t=>({...t,effective_from:e.target.value}))}),s.jsx("input",{type:"month",className:"border rounded px-2 py-1 text-sm",value:a.effective_to,onChange:e=>r(t=>({...t,effective_to:e.target.value}))}),s.jsx("button",{onClick:w,className:"bg-blue-600 text-white rounded px-3 py-1 text-sm",children:a.editingId?"Update":"Add"})]}),s.jsx("div",{className:"border rounded max-h-80 overflow-auto",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"bg-gray-50",children:s.jsxs("tr",{children:[s.jsx("th",{className:"text-left px-3 py-2",children:"From"}),s.jsx("th",{className:"text-left px-3 py-2",children:"To"}),s.jsx("th",{className:"text-left px-3 py-2",children:"Amount"}),s.jsx("th",{className:"text-left px-3 py-2",children:"Action"})]})}),s.jsxs("tbody",{children:[a.periods.map(e=>s.jsxs("tr",{className:"border-t",children:[s.jsx("td",{className:"px-3 py-2",children:e.effective_from}),s.jsx("td",{className:"px-3 py-2",children:e.effective_to??"Open"}),s.jsxs("td",{className:"px-3 py-2",children:["Rs. ",e.amount]}),s.jsxs("td",{className:"px-3 py-2 space-x-2",children:[s.jsx("button",{onClick:()=>C(e),className:"text-blue-600 text-xs",children:"Edit"}),s.jsx("button",{onClick:()=>_(e.id),className:"text-red-600 text-xs",children:"Delete"})]})]},e.id)),a.periods.length===0&&s.jsx("tr",{children:s.jsx("td",{colSpan:4,className:"px-3 py-3 text-gray-500",children:"No fee periods configured."})})]})]})})]})})]})}export{U as default};
