import{r as s,j as t}from"./app-uqy2rxhF.js";import{A as R}from"./AdminLayout-BZ-qH-wv.js";function D(){const x=new Date,[r,C]=s.useState([]),[l,E]=s.useState(""),[$,v]=s.useState([]),[i,g]=s.useState(""),[b,M]=s.useState(x.getFullYear()),[f,_]=s.useState(String(x.getMonth()+1).padStart(2,"0")),[y,N]=s.useState(null),[w,A]=s.useState(!1),L=s.useMemo(()=>r.find(e=>String(e.id)===String(l)),[r,l])?.type==="Kirtan";s.useEffect(()=>{fetch("/admin/classes/options").then(e=>e.json()).then(C).catch(()=>C([]))},[]),s.useEffect(()=>{r.length&&!l&&E(String(r[0].id))},[r]),s.useEffect(()=>{if(!l){v([]),g(""),N(null);return}fetch(`/admin/sections/options?class_id=${l}`).then(e=>e.json()).then(e=>{v(e),g(e.length?String(e[0].id):"")}).catch(()=>{v([]),g("")})},[l]),s.useEffect(()=>{if(!i){N(null);return}A(!0),fetch(`/admin/attendance/grid?section_id=${i}&year=${b}&month=${parseInt(f)}`).then(e=>e.json()).then(N).finally(()=>A(!1))},[i,b,f]);const S=y?.days??[],d=y?.students??[],u=s.useMemo(()=>d.flatMap(e=>Object.values(e.records??{})),[d]),k=s.useMemo(()=>d.flatMap(e=>Object.values(e.records??{})).filter(e=>e.lesson_learned).length,[d]),o=s.useMemo(()=>({total:u.length,present:u.filter(e=>e.status==="present").length,absent:u.filter(e=>e.status==="absent").length,leave:u.filter(e=>e.status==="leave").length}),[u]),I=o.total>0?Math.round(o.present/o.total*100):0;return t.jsxs(R,{title:"Attendance Report",children:[t.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-center",children:[t.jsx("select",{value:l,onChange:e=>E(e.target.value),className:"border px-3 py-2 rounded text-sm",children:r.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("select",{value:i,onChange:e=>g(e.target.value),className:"border px-3 py-2 rounded text-sm",disabled:!$.length,children:$.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("input",{type:"month",value:`${b}-${f}`,onChange:e=>{const[a,m]=e.target.value.split("-");M(parseInt(a)),_(m)},className:"border px-3 py-2 rounded text-sm"}),t.jsx("button",{onClick:()=>{const e=document.createElement("form");e.method="POST",e.action="/admin/reports/export/pdf",e.target="_blank";const a=document.createElement("input");a.type="hidden",a.name="_token",a.value=document.querySelector('meta[name="csrf-token"]').getAttribute("content");const m={report:"attendance",class_ids:l?[l]:[],section_ids:i?[i]:[],student_ids:d?d.map(n=>n.id):[],status:null,month:parseInt(f),year:b};Object.entries(m).forEach(([n,c])=>{if(Array.isArray(c))c.forEach(p=>{const j=document.createElement("input");j.type="hidden",j.name=`${n}[]`,j.value=p,e.appendChild(j)});else if(c!=null){const p=document.createElement("input");p.type="hidden",p.name=n,p.value=c,e.appendChild(p)}}),e.appendChild(a),document.body.appendChild(e),e.submit(),document.body.removeChild(e)},disabled:!u.length,className:"px-4 py-2 bg-red-600 text-white rounded text-sm disabled:opacity-50",children:"Export PDF"})]}),y&&t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4 mb-6",children:[t.jsx(h,{label:"Total Records",value:o.total}),t.jsx(h,{label:"Present",value:o.present}),t.jsx(h,{label:"Absent",value:o.absent}),t.jsx(h,{label:"Leave",value:o.leave}),t.jsx(h,{label:"Attendance %",value:`${I}%`}),t.jsx(h,{label:"Lessons Learned",value:k})]}),t.jsxs("div",{className:"relative bg-white border rounded overflow-x-auto",children:[(w||!y)&&t.jsx("div",{className:"absolute inset-0 bg-white/70 flex items-center justify-center z-30",children:t.jsx("p",{className:"text-sm text-gray-500",children:w?"Loading attendance...":"Attendance report will appear here"})}),t.jsxs("table",{className:"min-w-max text-sm border-collapse",children:[t.jsx("thead",{className:"bg-gray-50 sticky top-0 z-20",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 sticky left-0 bg-gray-50 z-30 text-left",children:"Student"}),S.map(e=>t.jsx("th",{className:`px-2 py-2 text-center ${e.enabled?"":"text-gray-300"}`,children:e.day},e.date))]})}),t.jsxs("tbody",{children:[d.map(e=>t.jsxs("tr",{className:"border-b",children:[t.jsx("td",{className:"px-3 py-2 sticky left-0 bg-white z-10 font-medium",children:e.name}),S.map(a=>{const m=`${e.id}-${a.date}`,n=e.records?.[m]?.status??null,c=n==="present"?"bg-green-200 text-green-800":n==="absent"?"bg-red-200 text-red-800":n==="leave"?"bg-yellow-200 text-yellow-800":"";return t.jsxs("td",{className:`px-2 py-2 text-center select-none ${c}
    ${a.enabled?"":"bg-gray-100 text-gray-300"}`,children:[n?n[0].toUpperCase():"—",L&&n==="present"&&Number(e.records?.[m]?.lesson_learned)===1&&t.jsx("div",{className:"mt-1 text-[10px] text-blue-700 font-semibold",children:"Lesson ✓"})]},a.date)})]},e.id)),!d.length&&t.jsx("tr",{children:t.jsx("td",{colSpan:S.length+1,className:"px-4 py-6 text-center text-gray-500",children:"No students found in this section"})})]})]})]})]})}function h({label:x,value:r}){return t.jsxs("div",{className:"bg-white border rounded p-4",children:[t.jsx("div",{className:"text-xs text-gray-500",children:x}),t.jsx("div",{className:"text-lg font-semibold",children:r})]})}export{D as default};
